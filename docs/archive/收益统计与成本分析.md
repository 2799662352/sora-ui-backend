# 💰 收益统计与成本分析

> 基于 Prisma aggregate 的精确成功/失败率统计

## 🎯 核心指标说明

### 1. 成功任务（赚钱）✅

```typescript
成功任务 = 状态为 COMPLETED 的任务数量
收益 = 成功任务数 × 单价
```

**数据来源**：
```typescript
const completedTasks = await prisma.videoTask.count({
  where: { status: TaskStatus.COMPLETED }
});
```

**收益计算**：
- 假设每个成功视频收费：$0.10 USD
- 10 个成功任务 = $1.00 USD

### 2. 失败任务（亏钱）❌

```typescript
失败任务 = 状态为 FAILED 的任务数量
损失 = 失败任务数 × API成本 + 潜在收益损失
```

**数据来源**：
```typescript
const failedTasks = await prisma.videoTask.count({
  where: { status: TaskStatus.FAILED }
});
```

**成本分析**：
- API 调用成本（已发生）：每次 $0.05 USD
- 潜在收益损失：每次 $0.10 USD
- **总损失** = $0.05 + $0.10 = $0.15 USD/任务

### 3. 成功率（最重要）📊

```typescript
成功率 = (成功任务数 / 总任务数) × 100%
```

**Prisma aggregate 计算**：
```typescript
const stats = await prisma.videoTask.groupBy({
  by: ['status'],
  _count: { id: true },
});

const total = stats.reduce((sum, s) => sum + s._count.id, 0);
const completed = stats.find(s => s.status === 'COMPLETED')?._count.id || 0;
const successRate = (completed / total) * 100;
```

**盈利标准**：
- 🎉 **90%+ 成功率**：优秀，高盈利
- ⚠️  **70-90% 成功率**：良好，可盈利
- 🚨 **<70% 成功率**：需改进，盈利不佳

---

## 💵 收益计算公式

### 基础公式

```typescript
// 收入
总收入 = 成功任务数 × 单价

// 成本
总成本 = 总任务数 × API单次成本

// 利润
毛利润 = 总收入 - 总成本
利润率 = (毛利润 / 总收入) × 100%

// 损失
失败成本 = 失败任务数 × API单次成本
潜在收益损失 = 失败任务数 × 单价
总损失 = 失败成本 + 潜在收益损失
```

### 实际示例

假设：
- 总任务：100 个
- 成功：85 个
- 失败：15 个
- 单价：$0.10
- API 成本：$0.05

**收益计算**：
```
总收入 = 85 × $0.10 = $8.50
总成本 = 100 × $0.05 = $5.00
毛利润 = $8.50 - $5.00 = $3.50
利润率 = ($3.50 / $8.50) × 100% = 41.2%
```

**损失计算**：
```
失败成本 = 15 × $0.05 = $0.75
潜在收益损失 = 15 × $0.10 = $1.50
总损失 = $0.75 + $1.50 = $2.25
```

**如果全部成功的话**：
```
潜在总收入 = 100 × $0.10 = $10.00
潜在总成本 = 100 × $0.05 = $5.00
潜在毛利润 = $10.00 - $5.00 = $5.00
实际损失 = $5.00 - $3.50 = $1.50 (由于15个失败)
```

---

## 📊 Prisma 统计查询

### 1. 精确的成功/失败统计

```typescript
// 并行查询（最快）
const [total, completed, failed] = await Promise.all([
  prisma.videoTask.count(),
  prisma.videoTask.count({ where: { status: TaskStatus.COMPLETED } }),
  prisma.videoTask.count({ where: { status: TaskStatus.FAILED } }),
]);

const successRate = total > 0 ? (completed / total) * 100 : 0;
```

### 2. 使用 groupBy 统计各状态

```typescript
// 一次查询获取所有状态统计
const statusStats = await prisma.videoTask.groupBy({
  by: ['status'],
  _count: { id: true },
});

// 结果示例：
// [
//   { status: 'COMPLETED', _count: { id: 85 } },
//   { status: 'FAILED', _count: { id: 15 } },
//   { status: 'PROCESSING', _count: { id: 10 } },
// ]
```

### 3. 按用户统计收益

```typescript
// 查询每个用户的成功/失败任务数
const userStats = await prisma.videoTask.groupBy({
  by: ['userId', 'status'],
  _count: { id: true },
});

// 计算每个用户的收益
const userRevenue = new Map();
userStats.forEach(stat => {
  if (stat.status === 'COMPLETED') {
    const revenue = stat._count.id * 0.10;
    userRevenue.set(stat.userId, revenue);
  }
});
```

### 4. 按时间统计趋势

```typescript
// 按天统计成功/失败趋势
const dailyStats = await prisma.$queryRaw`
  SELECT 
    DATE(created_at) as date,
    status,
    COUNT(*) as count
  FROM "video_tasks"
  WHERE created_at >= NOW() - INTERVAL '30 days'
  GROUP BY DATE(created_at), status
  ORDER BY date DESC
`;

// 可以看到每天的成功率变化趋势
```

---

## 🔍 数据准确性验证

### 方法 1：对比数据库直接查询

```sql
-- 直接在数据库中查询验证
SELECT 
  status,
  COUNT(*) as count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
FROM "video_tasks"
GROUP BY status;
```

### 方法 2：Prisma Studio 验证

```powershell
# 打开 Prisma Studio
npx prisma studio

# 在浏览器中：
# 1. 打开 VideoTask 表
# 2. 按 status 分组查看
# 3. 对比 API 返回的数据
```

### 方法 3：测试脚本验证

```powershell
# 运行验证脚本
.\test-stats.ps1

# 对比：
# - 基础统计 API
# - 增强统计 API（Prisma aggregate）
# - Prisma Studio 显示的数据
# 三者应完全一致
```

---

## 📈 收益优化建议

### 1. 提高成功率

**当前成功率 < 70%**：
- 检查 API 配置是否正确
- 优化 prompt 质量
- 实现失败重试机制
- 监控常见失败原因

**提升到 90%+**：
```
假设从 70% 提升到 90%：
- 原收益：70 × $0.10 = $7.00
- 新收益：90 × $0.10 = $9.00
- 增加收益：$2.00 (+28.6%)
```

### 2. 降低 API 成本

- 使用批量处理接口
- 实现智能缓存机制
- 优化 API 调用次数
- 考虑使用更便宜的 API 提供商

### 3. 提高单价

- 提供增值服务（更高质量、更长时长）
- 差异化定价策略
- VIP 用户专享功能

---

## 🎯 实时监控建议

### 1. 设置成功率警报

```typescript
// 当成功率低于阈值时发送警报
if (stats.successRate < 70) {
  await sendAlert({
    type: 'warning',
    message: `成功率过低：${stats.successRate}%`,
    suggestion: '请检查 API 配置和系统状态',
  });
}
```

### 2. 失败任务自动分析

```typescript
// 统计失败原因
const failureReasons = await prisma.videoTask.groupBy({
  by: ['errorCode'],
  where: { status: TaskStatus.FAILED },
  _count: { id: true },
  orderBy: { _count: { id: 'desc' } },
  take: 5,
});

// Top 5 失败原因
failureReasons.forEach(reason => {
  console.log(`错误代码 ${reason.errorCode}: ${reason._count.id} 次`);
});
```

### 3. 用户收益排行

```typescript
// 找出最赚钱的用户
const topProfitableUsers = await prisma.videoTask.groupBy({
  by: ['userId'],
  where: { status: TaskStatus.COMPLETED },
  _count: { id: true },
  orderBy: { _count: { id: 'desc' } },
  take: 10,
});
```

---

## 💡 盈利模式建议

### 模式 1：按量计费
- 每个成功视频收费 $0.10
- 失败任务不收费但产生成本
- **关键**：提高成功率

### 模式 2：会员订阅
- 月度订阅：$9.99/月（100个视频）
- 年度订阅：$99.99/年（1500个视频）
- 超出配额按 $0.15/个计费

### 模式 3：阶梯定价
- 0-100 个：$0.15/个
- 101-500 个：$0.12/个
- 501+ 个：$0.10/个

---

## 📊 关键数据表

| 指标 | 数据来源 | 计算方式 | 用途 |
|------|---------|---------|------|
| 成功任务数 | `prisma.videoTask.count({ where: { status: 'COMPLETED' } })` | 数据库计数 | 计算收益 |
| 失败任务数 | `prisma.videoTask.count({ where: { status: 'FAILED' } })` | 数据库计数 | 计算损失 |
| 成功率 | `(completed / total) × 100` | 比率计算 | 评估系统健康度 |
| 总收益 | `completed × 单价` | 乘法 | 财务报表 |
| 总成本 | `total × API成本` | 乘法 | 成本控制 |
| 毛利润 | `收益 - 成本` | 减法 | 盈利能力 |
| 利润率 | `(毛利润 / 收益) × 100` | 比率 | 盈利健康度 |

---

## ✅ 数据准确性保证

### Prisma aggregate 优势

1. **数据库层计算**
   - 不加载数据到内存
   - 直接在 PostgreSQL 中聚合
   - 避免人为计算错误

2. **类型安全**
   - TypeScript 完整类型支持
   - 编译时检查
   - 避免运行时错误

3. **并行查询**
   - 多个统计并行执行
   - 响应速度快
   - 数据一致性保证

4. **实时数据**
   - 每次查询都是最新数据
   - 不依赖缓存
   - 适合实时监控

---

## 🚨 重要提醒

**成功/失败统计直接影响盈利，必须确保数据准确！**

建议：
1. ✅ 使用 Prisma aggregate（数据库层聚合）
2. ✅ 定期验证数据（对比 Prisma Studio）
3. ✅ 实时监控成功率
4. ✅ 分析失败原因并改进
5. ✅ 记录详细的错误信息

---

## 📞 验证命令

```powershell
# 1. 运行统计测试
cd sora-ui-backend
.\test-stats.ps1

# 2. 查看数据库
npx prisma studio

# 3. 直接数据库查询
psql -U postgres -d sora_ui_db -c "
  SELECT 
    status,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
  FROM video_tasks
  GROUP BY status;
"

# 4. 启动管理员面板
cd ..\sora-admin-nextjs
npm run dev  # http://localhost:3000/dashboard/video-stats
```

---

**✅ 确保数据准确，是盈利的基础！**


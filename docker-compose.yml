services:
  # ============ Redis ç¼“å­˜å±‚ ============
  redis:
    image: redis:7-alpine
    container_name: sora-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - sora-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ============ PostgreSQL æ•°æ®åº“ ============
  postgres:
    image: postgres:15-alpine
    container_name: sora-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sorauser
      - POSTGRES_PASSWORD=sora_password_2024
      - POSTGRES_DB=soraui
      - TZ=Asia/Shanghai
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - sora-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sorauser -d soraui"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ Sora UI Backend API ============
  backend:
    # ğŸ”¥ ä½¿ç”¨ Docker Hub é•œåƒï¼ˆå·²ä¿®å¤æ‰€æœ‰ Bugï¼ŒåŒ…å« Remix åŠŸèƒ½ï¼‰
    image: zuozuoliang999/sora-ui-backend:v1.2.1-remix
    # å¦‚éœ€ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šï¼š
    # image: zuozuoliang999/sora-ui-backend:latest
    container_name: sora-ui-backend
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      # ğŸ”¥ ä¼˜åŒ–ï¼šæ·»åŠ è¿æ¥æ± å‚æ•°ï¼ˆå‚è€ƒPrismaæœ€ä½³å®è·µï¼Œé¢„æœŸæ€§èƒ½+30%ï¼‰
      - DATABASE_URL=postgresql://sorauser:sora_password_2024@postgres:5432/soraui?schema=public&connection_limit=20&pool_timeout=10&connect_timeout=10
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - ENABLE_REDIS_CACHE=true
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - LICENSE_SECRET=${LICENSE_SECRET:-change-me-in-production}
      - JWT_EXPIRES_IN=7d
      - CORS_ORIGIN=*
      - APIYI_API_KEY=${APIYI_API_KEY:-}
      - VIDEO_POLL_INTERVAL=${VIDEO_POLL_INTERVAL:-30000}
      - VIDEO_MAX_POLL_ATTEMPTS=${VIDEO_MAX_POLL_ATTEMPTS:-20}
    volumes:
      - ./updates:/app/updates:ro  # æ›´æ–°æ–‡ä»¶åªè¯»
      - ./logs:/app/logs           # æ—¥å¿—æŒä¹…åŒ–
    networks:
      - sora-network
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # ============ Nginx åå‘ä»£ç† ============
  nginx:
    image: nginx:alpine
    container_name: sora-ui-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./updates:/var/www/updates:ro  # æ›´æ–°æ–‡ä»¶æœåŠ¡
    depends_on:
      - backend
    networks:
      - sora-network

networks:
  sora-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
  postgres-data:
    driver: local


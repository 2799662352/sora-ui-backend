# ğŸ¯ è§†é¢‘ä»»åŠ¡ API éƒ¨ç½²å†³ç­–æŒ‡å—

## åº”è¯¥åœ¨æœ¬åœ°è¿˜æ˜¯äº‘ç«¯éƒ¨ç½²ï¼Ÿ

### å»ºè®®ï¼š**å…ˆæœ¬åœ°ï¼Œåäº‘ç«¯** â­

## ğŸ“‹ å®Œæ•´éƒ¨ç½²æµç¨‹ï¼ˆæ¨èï¼‰

### ğŸ  æ­¥éª¤ 1: æœ¬åœ°å¼€å‘ç¯å¢ƒæµ‹è¯•ï¼ˆ30 åˆ†é’Ÿï¼‰

**ç›®çš„**: éªŒè¯ä»£ç æ­£ç¡®æ€§ï¼Œé¿å…åœ¨ç”Ÿäº§ç¯å¢ƒå‡ºé—®é¢˜

**æ“ä½œæ­¥éª¤**:

```powershell
# 1. è¿›å…¥åç«¯ç›®å½•
cd D:\tecx\text\25\soraui_4.0\sora-ui-backend

# 2. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
npm install

# 3. ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npx prisma generate

# 4. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
npx prisma migrate dev --name add_video_tasks

# 5. å¯åŠ¨æœ¬åœ°æœåŠ¡
docker-compose down
docker-compose up -d

# 6. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api
```

**æµ‹è¯•æ¸…å•**:
- [ ] æœåŠ¡å¯åŠ¨æ— é”™è¯¯
- [ ] æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] è§†é¢‘ä»»åŠ¡ API å¯è°ƒç”¨
- [ ] å‰ç«¯é›†æˆæµ‹è¯•é€šè¿‡

---

### â˜ï¸ æ­¥éª¤ 2: éƒ¨ç½²åˆ°è…¾è®¯äº‘ï¼ˆ20 åˆ†é’Ÿï¼‰

**å‰æ**: æœ¬åœ°æµ‹è¯•å…¨éƒ¨é€šè¿‡ âœ…

#### æ–¹æ¡ˆ A: Git æ¨é€ + äº‘ç«¯æ‹‰å–ï¼ˆæ¨èï¼‰â­

**ä¼˜ç‚¹**: ç‰ˆæœ¬å¯æ§ã€æ˜“äºå›æ»šã€ç¬¦åˆ CI/CD æœ€ä½³å®è·µ

```powershell
# === æœ¬åœ°æ“ä½œ ===

# 1. æäº¤ä»£ç åˆ° GitHub
cd D:\tecx\text\25\soraui_4.0\sora-ui-backend
git add .
git commit -m "feat: æ·»åŠ è§†é¢‘ä»»åŠ¡ç®¡ç† API

- æ–°å¢ VideoTask æ•°æ®æ¨¡å‹
- å®ç°å®Œæ•´çš„ä»»åŠ¡ CRUD API
- æ”¯æŒå¼‚æ­¥ä»»åŠ¡è‡ªåŠ¨è½®è¯¢
- æ·»åŠ ä»»åŠ¡ç»Ÿè®¡åŠŸèƒ½
"
git push origin main

# === äº‘ç«¯æ“ä½œ ===

# 2. SSH ç™»å½•è…¾è®¯äº‘
ssh ubuntu@175.27.250.155

# 3. è¿›å…¥éƒ¨ç½²ç›®å½•
cd /opt/sora-ui-deploy/backend

# 4. å¤‡ä»½æ•°æ®åº“ï¼ˆé‡è¦ï¼ï¼‰
docker-compose exec postgres pg_dump -U sorauser sora_ui > backup_$(date +%Y%m%d_%H%M%S).sql

# 5. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 6. æ·»åŠ ç¯å¢ƒå˜é‡
nano .env
# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
APIYI_API_KEY=sk-fkmcuF2M7pwW1X9oE8E9Ba553e694f5388A85519A4D2Bc67
VIDEO_POLL_INTERVAL=30000
VIDEO_MAX_POLL_ATTEMPTS=20
VIDEO_TASK_RETENTION_DAYS=30

# 7. è¿è¡Œæ•°æ®åº“è¿ç§»
docker-compose exec api npx prisma generate
docker-compose exec api npx prisma migrate deploy

# 8. é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose down
docker-compose build --no-cache api
docker-compose up -d

# 9. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose logs -f api
# çœ‹åˆ° "ğŸš€ Sora UI Backend API å·²å¯åŠ¨" è¡¨ç¤ºæˆåŠŸ

# 10. éªŒè¯è¿ç§»
docker-compose exec postgres psql -U sorauser -d sora_ui -c "\d video_tasks"
```

#### æ–¹æ¡ˆ B: ç›´æ¥ä¸Šä¼ æ–‡ä»¶ï¼ˆå¿«é€Ÿä½†ä¸æ¨èï¼‰

```powershell
# æœ¬åœ°æ‰§è¡Œ
cd D:\tecx\text\25\soraui_4.0\sora-ui-backend

# ä¸Šä¼ ä»£ç ï¼ˆæ’é™¤ node_modulesï¼‰
scp -r `
  prisma `
  src `
  package.json `
  package-lock.json `
  tsconfig.json `
  Dockerfile `
  docker-compose.yml `
  add-video-tasks-migration.sql `
  ubuntu@175.27.250.155:/opt/sora-ui-deploy/backend/

# ç„¶åæŒ‰æ–¹æ¡ˆ A çš„æ­¥éª¤ 2-10 æ“ä½œ
```

---

### ğŸ§ª æ­¥éª¤ 3: ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼ˆ10 åˆ†é’Ÿï¼‰

**åœ¨æœ¬åœ° PowerShell æ‰§è¡Œ**:

```powershell
# 1. æµ‹è¯•å¥åº·æ£€æŸ¥
Invoke-RestMethod -Uri "https://api.zuo2799662352.xyz/health"

# 2. ç™»å½•è·å– token
$loginBody = @{
    username = "admin"
    password = "admin123"
} | ConvertTo-Json

$loginResult = Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/auth/login" `
    -Method Post `
    -ContentType "application/json" `
    -Body $loginBody

$token = $loginResult.data.token
Write-Host "Token: $token"

# 3. æµ‹è¯•è§†é¢‘ä»»åŠ¡ API
$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# åˆ›å»ºä»»åŠ¡
$taskBody = @{
    prompt = "ç”Ÿäº§ç¯å¢ƒæµ‹è¯• - ä¸€åªå¯çˆ±çš„å°çŒ«"
    model = "sora_video2"
    duration = 10
    aspectRatio = "16:9"
} | ConvertTo-Json

Write-Host "åˆ›å»ºæµ‹è¯•ä»»åŠ¡..."
$taskResult = Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/video/tasks" `
    -Method Post `
    -Headers $headers `
    -Body $taskBody

$videoId = $taskResult.data.videoId
Write-Host "âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ: $videoId"

# æŸ¥è¯¢ä»»åŠ¡
Write-Host "`næŸ¥è¯¢ä»»åŠ¡è¯¦æƒ…..."
$taskDetail = Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/video/tasks/$videoId" `
    -Method Get `
    -Headers $headers

Write-Host "çŠ¶æ€: $($taskDetail.data.status)"
Write-Host "è¿›åº¦: $($taskDetail.data.progress)%"

# è·å–ä»»åŠ¡åˆ—è¡¨
Write-Host "`nè·å–ä»»åŠ¡åˆ—è¡¨..."
$taskList = Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/video/tasks?page=1&pageSize=5" `
    -Method Get `
    -Headers $headers

Write-Host "æ€»ä»»åŠ¡æ•°: $($taskList.data.total)"
Write-Host "å½“å‰é¡µä»»åŠ¡: $($taskList.data.tasks.Count)"

# è·å–ç»Ÿè®¡
Write-Host "`nè·å–ç»Ÿè®¡ä¿¡æ¯..."
$stats = Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/video/stats" `
    -Method Get `
    -Headers $headers

Write-Host "æ€»è®¡: $($stats.data.total)"
Write-Host "å·²å®Œæˆ: $($stats.data.completed)"
Write-Host "å¤„ç†ä¸­: $($stats.data.processing)"
Write-Host "é˜Ÿåˆ—ä¸­: $($stats.data.queued)"
Write-Host "å¤±è´¥: $($stats.data.failed)"

Write-Host "`nâœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
```

---

## å¿«é€Ÿå†³ç­–æµç¨‹å›¾

```
å¼€å§‹
  â†“
æ˜¯å¦æœ‰ç´§æ€¥ä¸Šçº¿éœ€æ±‚ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ç›´æ¥éƒ¨ç½²åˆ°äº‘ç«¯ï¼ˆé£é™©è¾ƒé«˜ï¼‰
  â”‚        â””â”€ å‡†å¤‡å¥½å›æ»šæ–¹æ¡ˆ
  â”‚
  â””â”€ å¦ â†’ å…ˆæœ¬åœ°æµ‹è¯•ï¼ˆæ¨èï¼‰âœ…
           â†“
        æœ¬åœ°æµ‹è¯•é€šè¿‡ï¼Ÿ
           â”œâ”€ æ˜¯ â†’ éƒ¨ç½²åˆ°äº‘ç«¯
           â”‚        â†“
           â”‚     ç”Ÿäº§éªŒè¯é€šè¿‡ï¼Ÿ
           â”‚        â”œâ”€ æ˜¯ â†’ å®Œæˆ âœ…
           â”‚        â””â”€ å¦ â†’ å›æ»š
           â”‚
           â””â”€ å¦ â†’ ä¿®å¤é—®é¢˜
                   â””â”€ é‡æ–°æœ¬åœ°æµ‹è¯•
```

---

## å½“å‰å»ºè®®

### ğŸ¯ æ¨èæ–¹æ¡ˆï¼šæœ¬åœ° â†’ äº‘ç«¯

**ç†ç”±**:
1. âœ… æ–°åŠŸèƒ½è¾ƒå¤æ‚ï¼ˆæ•°æ®åº“è¿ç§» + æ–° APIï¼‰
2. âœ… å½±å“ç°æœ‰ç³»ç»Ÿï¼ˆéœ€è¦ä¿®æ”¹æ•°æ®åº“ï¼‰
3. âœ… æœ‰å……è¶³æ—¶é—´æµ‹è¯•
4. âœ… é™ä½ç”Ÿäº§ç¯å¢ƒé£é™©

**æ‰§è¡Œé¡ºåº**:
```
1. æœ¬åœ°æµ‹è¯•ï¼ˆ30åˆ†é’Ÿï¼‰
   â†“
2. æäº¤åˆ° GitHubï¼ˆ5åˆ†é’Ÿï¼‰
   â†“
3. äº‘ç«¯éƒ¨ç½²ï¼ˆ20åˆ†é’Ÿï¼‰
   â†“
4. ç”Ÿäº§éªŒè¯ï¼ˆ10åˆ†é’Ÿï¼‰
   â†“
5. å‰ç«¯é›†æˆï¼ˆæ ¹æ®éœ€è¦ï¼‰
```

---

## æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | æ“ä½œ | é¢„è®¡æ—¶é—´ |
|-----|------|---------|
| 1 | æœ¬åœ°ç¯å¢ƒå‡†å¤‡ | 5åˆ†é’Ÿ |
| 2 | æœ¬åœ°æ•°æ®åº“è¿ç§» | 5åˆ†é’Ÿ |
| 3 | æœ¬åœ°åŠŸèƒ½æµ‹è¯• | 20åˆ†é’Ÿ |
| 4 | Git æäº¤æ¨é€ | 5åˆ†é’Ÿ |
| 5 | æ•°æ®åº“å¤‡ä»½ | 5åˆ†é’Ÿ |
| 6 | äº‘ç«¯ä»£ç æ‹‰å– | 2åˆ†é’Ÿ |
| 7 | äº‘ç«¯æ•°æ®åº“è¿ç§» | 5åˆ†é’Ÿ |
| 8 | äº‘ç«¯æœåŠ¡é‡å¯ | 3åˆ†é’Ÿ |
| 9 | ç”Ÿäº§ç¯å¢ƒéªŒè¯ | 10åˆ†é’Ÿ |
| **æ€»è®¡** | | **çº¦ 60 åˆ†é’Ÿ** |

---

## é£é™©è¯„ä¼°

### æœ¬åœ°æµ‹è¯•çš„é£é™©: ğŸŸ¢ ä½
- å¯ä»¥éšæ—¶å›æ»š
- ä¸å½±å“ç”Ÿäº§ç¯å¢ƒ
- å¯ä»¥åå¤æµ‹è¯•

### ç›´æ¥éƒ¨ç½²äº‘ç«¯çš„é£é™©: ğŸŸ¡ ä¸­
- å¯èƒ½å½±å“ç°æœ‰ç”¨æˆ·
- æ•°æ®åº“è¿ç§»ä¸å¯é€†
- å‡ºé”™éœ€è¦ç´§æ€¥å›æ»š

---

## æœ€ç»ˆå»ºè®®

### ğŸŒŸ æ ‡å‡†æµç¨‹ï¼ˆæ¨èï¼‰

**ä»Šå¤©ï¼ˆç¬¬1å¤©ï¼‰**:
1. âœ… æœ¬åœ°æµ‹è¯•æ–°åŠŸèƒ½
2. âœ… æäº¤ä»£ç åˆ° GitHub
3. âœ… å‡†å¤‡éƒ¨ç½²æ–‡æ¡£

**æ˜å¤©ï¼ˆç¬¬2å¤©ï¼‰**:
1. âœ… å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
2. âœ… éƒ¨ç½²åˆ°è…¾è®¯äº‘
3. âœ… ç”Ÿäº§éªŒè¯
4. âœ… å‰ç«¯é›†æˆ

### âš¡ å¿«é€Ÿæµç¨‹ï¼ˆå¦‚æœç¡®æœ‰æŠŠæ¡ï¼‰

**ä»Šå¤©ï¼ˆä¸€æ¬¡æ€§å®Œæˆï¼‰**:
1. âœ… æœ¬åœ°å¿«é€Ÿæµ‹è¯•ï¼ˆ30åˆ†é’Ÿï¼‰
2. âœ… ç«‹å³éƒ¨ç½²äº‘ç«¯ï¼ˆ20åˆ†é’Ÿï¼‰
3. âœ… ç”Ÿäº§éªŒè¯ï¼ˆ10åˆ†é’Ÿï¼‰

---

## ä¸‹ä¸€æ­¥æ“ä½œ

ç°åœ¨è¯·å‘Šè¯‰æˆ‘æ‚¨çš„é€‰æ‹©ï¼š

**é€‰é¡¹ A**: å…ˆåœ¨æœ¬åœ°æµ‹è¯•ï¼Œæ˜ç¡®æ— è¯¯åå†éƒ¨ç½² â­ï¼ˆæ¨èï¼‰
**é€‰é¡¹ B**: ç›´æ¥éƒ¨ç½²åˆ°è…¾è®¯äº‘ï¼Œå¿«é€Ÿä¸Šçº¿

æˆ‘ä¼šæ ¹æ®æ‚¨çš„é€‰æ‹©æä¾›å…·ä½“çš„æ‰§è¡Œå‘½ä»¤ã€‚

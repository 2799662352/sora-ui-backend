<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket å®æ—¶è¿›åº¦æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            display: inline-block;
            margin: 5px 0;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.authenticated { background: #d1ecf1; color: #0c5460; }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        .log-entry {
            margin: 4px 0;
        }
        .log-time {
            color: #858585;
        }
        .log-type {
            font-weight: bold;
            margin: 0 8px;
        }
        .log-type.info { color: #4CAF50; }
        .log-type.success { color: #2196F3; }
        .log-type.warning { color: #FF9800; }
        .log-type.error { color: #f44336; }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”Œ WebSocket å®æ—¶è¿›åº¦æµ‹è¯•</h1>
            <p>æµ‹è¯•å®æ—¶ä»»åŠ¡è¿›åº¦æ¨é€ï¼ˆcamelCase é©¼å³°å‘½åï¼‰</p>
        </div>

        <div class="content">
            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="section">
                <h2>ğŸ“¡ è¿æ¥çŠ¶æ€</h2>
                <span id="connStatus" class="status disconnected">æœªè¿æ¥</span>
                <span id="authStatus" class="status" style="display:none;">æœªè®¤è¯</span>
                <div style="margin-top: 15px;">
                    <button onclick="connect()">è¿æ¥ WebSocket</button>
                    <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
                </div>
            </div>

            <!-- è®¤è¯ -->
            <div class="section">
                <h2>ğŸ” è®¤è¯</h2>
                <input type="text" id="tokenInput" placeholder="è¾“å…¥ JWT Tokenï¼ˆä»ç™»å½•è·å–ï¼‰" />
                <div style="margin-top: 10px;">
                    <button onclick="authenticate()">è®¤è¯</button>
                    <button onclick="quickLogin()">å¿«é€Ÿç™»å½•è·å–Token</button>
                </div>
            </div>

            <!-- ä»»åŠ¡è®¢é˜… -->
            <div class="section">
                <h2>ğŸ“º ä»»åŠ¡è®¢é˜…</h2>
                <input type="text" id="videoIdInput" placeholder="è¾“å…¥ videoId" />
                <div style="margin-top: 10px;">
                    <button onclick="subscribeTask()">è®¢é˜…ä»»åŠ¡</button>
                    <button onclick="unsubscribeTask()">å–æ¶ˆè®¢é˜…</button>
                    <button onclick="createAndSubscribe()">åˆ›å»ºä»»åŠ¡å¹¶è®¢é˜…</button>
                    <button onclick="refreshVideoUrl()">ğŸ”„ åˆ·æ–°è§†é¢‘URL</button>
                </div>
            </div>

            <!-- å®æ—¶è¿›åº¦ -->
            <div class="section">
                <h2>ğŸ“Š å®æ—¶è¿›åº¦</h2>
                <div id="progressInfo" style="margin-bottom: 10px;">ç­‰å¾…ä»»åŠ¡æ•°æ®...</div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%;">0%</div>
                </div>
                <div id="taskDetails" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
            </div>

            <!-- æ¶ˆæ¯æ—¥å¿— -->
            <div class="section">
                <h2>ğŸ“‹ æ¶ˆæ¯æ—¥å¿—ï¼ˆcamelCaseæ ¼å¼ï¼‰</h2>
                <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                <div id="log" class="log"></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentToken = '';
        let currentVideoId = '';

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const colors = {
                info: 'info',
                success: 'success',
                warning: 'warning',
                error: 'error'
            };
            logEl.innerHTML = `<div class="log-entry"><span class="log-time">[${time}]</span><span class="log-type ${colors[type]}">${type.toUpperCase()}</span>${message}</div>` + logEl.innerHTML;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function connect() {
            if (ws) {
                log('WebSocket å·²è¿æ¥', 'warning');
                return;
            }

            ws = new WebSocket('ws://localhost:3001/ws');

            ws.onopen = () => {
                log('âœ… WebSocket è¿æ¥æˆåŠŸ', 'success');
                document.getElementById('connStatus').textContent = 'å·²è¿æ¥';
                document.getElementById('connStatus').className = 'status connected';
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onclose = () => {
                log('âŒ WebSocket è¿æ¥å…³é—­', 'warning');
                document.getElementById('connStatus').textContent = 'æœªè¿æ¥';
                document.getElementById('connStatus').className = 'status disconnected';
                document.getElementById('authStatus').style.display = 'none';
                ws = null;
            };

            ws.onerror = (error) => {
                log('âŒ WebSocket é”™è¯¯: ' + error, 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        function handleMessage(msg) {
            log(`ğŸ“¨ ${msg.type}: ${JSON.stringify(msg.payload, null, 2)}`, 'info');

            switch (msg.type) {
                case 'connected':
                    log('ğŸ‰ æœåŠ¡å™¨å“åº”: ' + msg.payload.serverVersion, 'success');
                    break;

                case 'authSuccess':
                    log('ğŸ”“ è®¤è¯æˆåŠŸ: ' + msg.payload.username, 'success');
                    document.getElementById('authStatus').textContent = 'å·²è®¤è¯ - ' + msg.payload.username;
                    document.getElementById('authStatus').className = 'status authenticated';
                    document.getElementById('authStatus').style.display = 'inline-block';
                    break;

                case 'authFailed':
                    log('ğŸ”’ è®¤è¯å¤±è´¥: ' + msg.payload.error, 'error');
                    break;

                case 'subscribeSuccess':
                    log('ğŸ“º è®¢é˜…æˆåŠŸ: ' + msg.payload.videoId, 'success');
                    currentVideoId = msg.payload.videoId;
                    break;

                case 'taskProgress':
                    updateProgress(msg.payload);
                    log(`ğŸ“Š è¿›åº¦æ›´æ–°: ${msg.payload.progress}% - ${msg.payload.message}`, 'info');
                    break;

                case 'taskCompleted':
                    updateProgress(msg.payload);
                    log('ğŸ‰ ä»»åŠ¡å®Œæˆï¼è§†é¢‘URL: ' + msg.payload.result.videoUrl, 'success');
                    break;

                case 'taskFailed':
                    log('âŒ ä»»åŠ¡å¤±è´¥: ' + msg.payload.error.message, 'error');
                    break;

                case 'taskStatus':
                    updateProgress(msg.payload);
                    log(`ğŸ“‹ ä»»åŠ¡çŠ¶æ€: ${msg.payload.status} - ${msg.payload.progress}%`, 'info');
                    break;

                case 'heartbeat':
                    // log('ğŸ’“ å¿ƒè·³', 'info');
                    break;
            }
        }

        function updateProgress(payload) {
            const progress = payload.progress || 0;
            const status = payload.status || '';
            const message = payload.message || '';
            const backendId = payload.videoId || '';
            const externalId = payload.externalVideoId || '';

            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = progress + '%';
            document.getElementById('progressInfo').innerHTML = `
                <strong>çŠ¶æ€:</strong> ${status} | 
                <strong>è¿›åº¦:</strong> ${progress}% | 
                <strong>æ¶ˆæ¯:</strong> ${message}
            `;

            // æ˜¾ç¤ºåŒID
            const idInfo = `
                <div style="background: #f0f0f0; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 12px;">
                    <strong>ğŸ“‹ åç«¯ID:</strong> <code>${backendId}</code><br>
                    <strong>ğŸŒ å¤–éƒ¨API ID:</strong> <code>${externalId || 'æœªæäº¤'}</code>
                </div>
            `;

            if (payload.result && payload.result.videoUrl) {
                document.getElementById('taskDetails').innerHTML = idInfo + `
                    <div style="margin-top: 10px;">
                        <strong>âœ… è§†é¢‘URL:</strong> <a href="${payload.result.videoUrl}" target="_blank" style="color: #667eea;">${payload.result.videoUrl}</a><br>
                        <strong>æ—¶é•¿:</strong> ${payload.result.duration || 'N/A'}s | 
                        <strong>åˆ†è¾¨ç‡:</strong> ${payload.result.resolution || 'N/A'}
                    </div>
                `;
            } else {
                document.getElementById('taskDetails').innerHTML = idInfo;
            }
        }

        function authenticate() {
            if (!ws) {
                log('è¯·å…ˆè¿æ¥ WebSocket', 'error');
                return;
            }

            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                log('è¯·è¾“å…¥ Token', 'error');
                return;
            }

            currentToken = token;

            ws.send(JSON.stringify({
                type: 'auth',
                id: 'auth-' + Date.now(),
                timestamp: Date.now(),
                payload: { token }
            }));

            log('ğŸ” å‘é€è®¤è¯è¯·æ±‚...', 'info');
        }

        function subscribeTask() {
            if (!ws) {
                log('è¯·å…ˆè¿æ¥ WebSocket', 'error');
                return;
            }

            const videoId = document.getElementById('videoIdInput').value.trim();
            if (!videoId) {
                log('è¯·è¾“å…¥ videoId', 'error');
                return;
            }

            ws.send(JSON.stringify({
                type: 'subscribe_task',
                id: 'sub-' + Date.now(),
                timestamp: Date.now(),
                payload: { videoId }
            }));

            log('ğŸ“º è®¢é˜…ä»»åŠ¡: ' + videoId, 'info');
        }

        function unsubscribeTask() {
            if (!ws || !currentVideoId) {
                log('æ²¡æœ‰è®¢é˜…çš„ä»»åŠ¡', 'error');
                return;
            }

            ws.send(JSON.stringify({
                type: 'unsubscribe_task',
                id: 'unsub-' + Date.now(),
                timestamp: Date.now(),
                payload: { videoId: currentVideoId }
            }));

            log('ğŸ“º å–æ¶ˆè®¢é˜…: ' + currentVideoId, 'info');
        }

        async function quickLogin() {
            log('ğŸ” å¿«é€Ÿç™»å½•ä¸­...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const token = data.data.token;
                    document.getElementById('tokenInput').value = token;
                    currentToken = token;
                    log('âœ… ç™»å½•æˆåŠŸï¼Token å·²è‡ªåŠ¨å¡«å……', 'success');
                    
                    // è‡ªåŠ¨è®¤è¯
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        setTimeout(() => authenticate(), 100);
                    }
                } else {
                    log('âŒ ç™»å½•å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                log('âŒ ç™»å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function createAndSubscribe() {
            if (!currentToken) {
                log('è¯·å…ˆç™»å½•è·å– Token', 'error');
                return;
            }

            log('ğŸ¬ åˆ›å»ºæµ‹è¯•ä»»åŠ¡...', 'info');

            try {
                const response = await fetch('http://localhost:3001/api/video/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        prompt: 'WebSocket æµ‹è¯• - ä¸€åªå¯çˆ±çš„å°çŒ«åœ¨é˜³å…‰ä¸‹ç©è€',
                        model: 'sora_video2',
                        duration: 5
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const videoId = data.data.videoId;
                    document.getElementById('videoIdInput').value = videoId;
                    log('âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ' + videoId, 'success');
                    
                    // è‡ªåŠ¨è®¢é˜…
                    setTimeout(() => subscribeTask(), 100);
                } else {
                    log('âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                log('âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function refreshVideoUrl() {
            const videoId = document.getElementById('videoIdInput').value.trim();
            
            if (!videoId) {
                log('è¯·è¾“å…¥ videoId', 'error');
                return;
            }

            if (!currentToken) {
                log('è¯·å…ˆç™»å½•è·å– Token', 'error');
                return;
            }

            log('ğŸ”„ åˆ·æ–°è§†é¢‘URLä¸­...', 'info');

            try {
                const response = await fetch(`http://localhost:3001/api/video/tasks/${videoId}/refresh-url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    }
                });

                const data = await response.json();
                if (data.success) {
                    const result = data.data;
                    log('âœ… è§†é¢‘URLå·²åˆ·æ–°ï¼', 'success');
                    log(`   åç«¯ID: ${result.videoId}`, 'info');
                    log(`   å¤–éƒ¨ID: ${result.externalVideoId}`, 'info');
                    log(`   è§†é¢‘URL: ${result.videoUrl}`, 'success');
                    log(`   åˆ·æ–°æ—¶é—´: ${new Date(result.refreshedAt).toLocaleTimeString()}`, 'info');
                    
                    // æ›´æ–°æ˜¾ç¤º
                    document.getElementById('taskDetails').innerHTML += `
                        <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px;">
                            <strong>ğŸ”„ URLå·²åˆ·æ–°</strong><br>
                            <a href="${result.videoUrl}" target="_blank" style="color: #667eea; word-break: break-all;">${result.videoUrl}</a>
                        </div>
                    `;
                } else {
                    log('âŒ åˆ·æ–°å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                log('âŒ åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.addEventListener('load', () => {
            log('ğŸŒŸ é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»"è¿æ¥ WebSocket"å¼€å§‹', 'info');
        });
    </script>
</body>
</html>


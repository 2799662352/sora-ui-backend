# ğŸ” è§†é¢‘ä»»åŠ¡ API éƒ¨ç½²æ£€æŸ¥æ¸…å•

## æœ¬åœ°ç¯å¢ƒæ£€æŸ¥ âœ…

### 1. ä»£ç å‡†å¤‡
- [ ] æ‰€æœ‰æ–°ä»£ç å·²æäº¤åˆ° Git
- [ ] package.json ä¾èµ–å·²æ›´æ–°
- [ ] Prisma schema å·²æ›´æ–°
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®

### 2. æœ¬åœ°æµ‹è¯•
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
- [ ] API æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] æ‰€æœ‰ç«¯ç‚¹è¿”å›æ­£ç¡®
- [ ] ä»»åŠ¡åˆ›å»ºåŠŸèƒ½æ­£å¸¸
- [ ] ä»»åŠ¡æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸
- [ ] ä»»åŠ¡åˆ—è¡¨åˆ†é¡µæ­£å¸¸

### 3. æµ‹è¯•å‘½ä»¤

```powershell
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹ API æ—¥å¿—
docker-compose logs -f api

# æµ‹è¯•å¥åº·æ£€æŸ¥
Invoke-RestMethod -Uri "http://localhost:3001/health"

# æµ‹è¯•è§†é¢‘ä»»åŠ¡ API
# (éœ€è¦å…ˆç™»å½•è·å– token)
```

---

## è…¾è®¯äº‘éƒ¨ç½²æ£€æŸ¥ ğŸš€

### 1. éƒ¨ç½²å‰å‡†å¤‡
- [ ] å¤‡ä»½å½“å‰æ•°æ®åº“
- [ ] å¤‡ä»½å½“å‰ä»£ç 
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ

### 2. æ•°æ®åº“å¤‡ä»½

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh ubuntu@175.27.250.155

# å¤‡ä»½æ•°æ®åº“
cd /opt/sora-ui-deploy
docker-compose exec postgres pg_dump -U sorauser sora_ui > backup_$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½åˆ°æœ¬åœ°
exit
scp ubuntu@175.27.250.155:/opt/sora-ui-deploy/backup_*.sql ./
```

### 3. ä»£ç ä¸Šä¼ 

```powershell
# ä»æœ¬åœ°ä¸Šä¼ ï¼ˆæ’é™¤ node_modulesï¼‰
cd D:\tecx\text\25\soraui_4.0\sora-ui-backend

# æ–¹æ³• 1: ä½¿ç”¨ SCP
scp -r `
  --exclude='node_modules' `
  --exclude='.git' `
  --exclude='dist' `
  * ubuntu@175.27.250.155:/opt/sora-ui-deploy/backend/

# æ–¹æ³• 2: ä½¿ç”¨ Gitï¼ˆæ¨èï¼‰
# å…ˆæ¨é€åˆ° GitHub
git add .
git commit -m "feat: æ·»åŠ è§†é¢‘ä»»åŠ¡ç®¡ç† API"
git push origin main

# æœåŠ¡å™¨ä¸Šæ‹‰å–
ssh ubuntu@175.27.250.155
cd /opt/sora-ui-deploy/backend
git pull origin main
```

### 4. æ•°æ®åº“è¿ç§»

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ

# æ–¹æ³• 1: ä½¿ç”¨ Prisma
docker-compose exec api npx prisma generate
docker-compose exec api npx prisma migrate deploy

# æ–¹æ³• 2: æ‰‹åŠ¨ SQLï¼ˆå¦‚æœ Prisma è¿ç§»å¤±è´¥ï¼‰
docker-compose exec postgres psql -U sorauser -d sora_ui < add-video-tasks-migration.sql

# éªŒè¯è¡¨æ˜¯å¦åˆ›å»º
docker-compose exec postgres psql -U sorauser -d sora_ui -c "\dt video_tasks"
```

### 5. ç¯å¢ƒå˜é‡æ›´æ–°

```bash
# ç¼–è¾‘ .env æ–‡ä»¶
nano /opt/sora-ui-deploy/backend/.env

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
APIYI_API_KEY=sk-fkmcuF2M7pwW1X9oE8E9Ba553e694f5388A85519A4D2Bc67
VIDEO_POLL_INTERVAL=30000
VIDEO_MAX_POLL_ATTEMPTS=20
VIDEO_TASK_RETENTION_DAYS=30
```

### 6. é‡å¯æœåŠ¡

```bash
cd /opt/sora-ui-deploy

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose down
docker-compose build --no-cache api
docker-compose up -d

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose logs -f api

# ç¡®è®¤æ‰€æœ‰å®¹å™¨è¿è¡Œæ­£å¸¸
docker-compose ps
```

### 7. éƒ¨ç½²åæµ‹è¯•

```powershell
# åœ¨æœ¬åœ°æ‰§è¡Œ

# 1. æµ‹è¯•å¥åº·æ£€æŸ¥
Invoke-RestMethod -Uri "https://api.zuo2799662352.xyz/health"

# 2. ç™»å½•è·å– token
$loginBody = @{
    username = "admin"
    password = "admin123"
} | ConvertTo-Json

$loginResult = Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/auth/login" `
    -Method Post `
    -ContentType "application/json" `
    -Body $loginBody

$token = $loginResult.data.token

# 3. æµ‹è¯•è§†é¢‘ä»»åŠ¡ API
$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# åˆ›å»ºä»»åŠ¡
$taskBody = @{
    prompt = "ä¸€åªå¯çˆ±çš„å°çŒ«åœ¨ç©è€"
    model = "sora_video2"
    duration = 10
    aspectRatio = "16:9"
} | ConvertTo-Json

$taskResult = Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/video/tasks" `
    -Method Post `
    -Headers $headers `
    -Body $taskBody

Write-Host "ä»»åŠ¡åˆ›å»ºæˆåŠŸ: $($taskResult.data.videoId)"

# æŸ¥è¯¢ä»»åŠ¡
Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/video/tasks/$($taskResult.data.videoId)" `
    -Method Get `
    -Headers $headers

# è·å–ä»»åŠ¡åˆ—è¡¨
Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/video/tasks?page=1&pageSize=10" `
    -Method Get `
    -Headers $headers

# è·å–ç»Ÿè®¡ä¿¡æ¯
Invoke-RestMethod `
    -Uri "https://api.zuo2799662352.xyz/api/video/stats" `
    -Method Get `
    -Headers $headers
```

### 8. ç›‘æ§å’Œæ—¥å¿—

```bash
# æŒç»­ç›‘æ§æ—¥å¿—
docker-compose logs -f api

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker-compose exec postgres psql -U sorauser -d sora_ui -c "SELECT COUNT(*) FROM video_tasks;"

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
docker stats

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h
```

---

## é—®é¢˜æ’æŸ¥ ğŸ”§

### å¦‚æœè¿ç§»å¤±è´¥

```bash
# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker-compose logs api

# 2. æ‰‹åŠ¨æ£€æŸ¥æ•°æ®åº“
docker-compose exec postgres psql -U sorauser -d sora_ui

# 3. æŸ¥çœ‹è¡¨ç»“æ„
\dt

# 4. å¦‚æœéœ€è¦é‡ç½®
DROP TABLE IF EXISTS video_tasks CASCADE;
\q

# 5. é‡æ–°è¿è¡Œè¿ç§»
docker-compose exec api npx prisma migrate deploy
```

### å¦‚æœæœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# 1. æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep 3001

# 2. æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose ps

# 3. é‡æ–°æ„å»ºï¼ˆå¼ºåˆ¶ï¼‰
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d

# 4. æŸ¥çœ‹å®Œæ•´æ—¥å¿—
docker-compose logs --tail=100 api
```

### å›æ»šæ–¹æ¡ˆ

```bash
# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. æ¢å¤æ•°æ®åº“
docker-compose exec postgres psql -U sorauser -d sora_ui < backup_20250113_120000.sql

# 3. å›æ»šä»£ç 
git reset --hard HEAD~1
# æˆ–
git checkout <previous-commit-hash>

# 4. é‡å¯æœåŠ¡
docker-compose up -d

# 5. éªŒè¯
curl http://localhost:3001/health
```

---

## éƒ¨ç½²å®Œæˆç¡®è®¤ âœ…

- [ ] æ‰€æœ‰å®¹å™¨è¿è¡Œæ­£å¸¸
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] è§†é¢‘ä»»åŠ¡ API å¯è®¿é—®
- [ ] ä»»åŠ¡åˆ›å»ºæˆåŠŸ
- [ ] ä»»åŠ¡æŸ¥è¯¢æ­£å¸¸
- [ ] æ—¥å¿—æ— é”™è¯¯
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] å‰ç«¯å¯ä»¥æ­£å¸¸è°ƒç”¨

---

## æ–‡æ¡£æ›´æ–°

- [ ] æ›´æ–° API æ–‡æ¡£
- [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£
- [ ] æ›´æ–° GitHub README
- [ ] è®°å½•æ­¤æ¬¡éƒ¨ç½²çš„å˜æ›´

---

**éƒ¨ç½²äººå‘˜**: ___________  
**éƒ¨ç½²æ—¶é—´**: ___________  
**ç‰ˆæœ¬å·**: v1.1.0  
**å¤‡æ³¨**: ___________


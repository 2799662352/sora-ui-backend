# ðŸš€ è…¾è®¯äº‘ Docker å¿«é€Ÿéƒ¨ç½²æŒ‡å—

ä¸€é”®éƒ¨ç½² Sora UI Backend åˆ°è…¾è®¯äº‘æœåŠ¡å™¨ã€‚

## ðŸ“‹ å‰ææ¡ä»¶

### å¿…éœ€ï¼š
- âœ… è…¾è®¯äº‘æœåŠ¡å™¨ï¼ˆå·²è´­ä¹°ï¼‰
- âœ… æœåŠ¡å™¨IP: `175.27.250.155`
- âœ… SSHè®¿é—®æƒé™
- âœ… åŸŸåå·²é…ç½®DNSï¼ˆå¯é€‰ï¼Œç”¨äºŽSSLï¼‰

### æœ¬åœ°çŽ¯å¢ƒï¼š
- Windows: PowerShell
- Linux/Mac: Bash

---

## âš¡ æ–¹å¼ä¸€ï¼šä¸€é”®éƒ¨ç½²ï¼ˆæŽ¨èï¼‰

### Windowsç”¨æˆ·ï¼š

```powershell
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
.\å¿«é€Ÿéƒ¨ç½²-è…¾è®¯äº‘.ps1
```

### Linux/Macç”¨æˆ·ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
chmod +x å¿«é€Ÿéƒ¨ç½²-è…¾è®¯äº‘.sh
./å¿«é€Ÿéƒ¨ç½²-è…¾è®¯äº‘.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š**
1. âœ… æ£€æŸ¥æœ¬åœ°çŽ¯å¢ƒ
2. âœ… è¿žæŽ¥æœåŠ¡å™¨
3. âœ… å‡†å¤‡éƒ¨ç½²ç›®å½•
4. âœ… ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
5. âœ… é…ç½®Docker Compose
6. âœ… å¯åŠ¨æ‰€æœ‰æœåŠ¡
7. âœ… å¯é€‰ï¼šé…ç½®SSLè¯ä¹¦

---

## ðŸ“¦ æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²ï¼ˆåˆ†æ­¥éª¤ï¼‰

### æ­¥éª¤1: è¿žæŽ¥æœåŠ¡å™¨

```bash
ssh ubuntu@175.27.250.155
```

### æ­¥éª¤2: å®‰è£…DockerçŽ¯å¢ƒ

```bash
# å®‰è£…Docker
curl -fsSL https://get.docker.com | sh
sudo systemctl start docker
sudo systemctl enable docker

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### æ­¥éª¤3: åˆ›å»ºéƒ¨ç½²ç›®å½•

```bash
# åˆ›å»ºç›®å½•ç»“æž„
sudo mkdir -p /opt/sora-ui-deploy/{backend,nginx/conf.d,certbot/{conf,www},logs,updates,postgres-data}
sudo chown -R ubuntu:ubuntu /opt/sora-ui-deploy
cd /opt/sora-ui-deploy
```

### æ­¥éª¤4: ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

**åœ¨æœ¬åœ°æ‰§è¡Œï¼š**

```bash
# Linux/Mac
rsync -avz --progress \
  --exclude 'node_modules' \
  --exclude '.git' \
  ./ ubuntu@175.27.250.155:/opt/sora-ui-deploy/backend/

# Windows (PowerShell)
scp -r * ubuntu@175.27.250.155:/opt/sora-ui-deploy/backend/
```

### æ­¥éª¤5: åˆ›å»º docker-compose.yml

**åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š**

```bash
cd /opt/sora-ui-deploy

cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    container_name: sora-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sorauser
      - POSTGRES_PASSWORD=sora_secure_pass_2024
      - POSTGRES_DB=sora_ui
      - TZ=Asia/Shanghai
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    networks:
      - sora-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sorauser -d sora_ui"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sora-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=sorauser
      - DB_PASSWORD=sora_secure_pass_2024
      - DB_NAME=sora_ui
      - JWT_SECRET=your-super-secure-jwt-secret-key-2024
      - LICENSE_SECRET=your-super-secure-license-key-2024
    volumes:
      - ./updates:/app/updates
      - ./logs:/app/logs
    networks:
      - sora-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:alpine
    container_name: sora-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
      - ./updates:/usr/share/nginx/html/updates:ro
    networks:
      - sora-network
    depends_on:
      - api

networks:
  sora-network:
    driver: bridge
EOF
```

### æ­¥éª¤6: åˆ›å»ºNginxé…ç½®

```bash
cat > nginx/conf.d/default.conf << 'EOF'
server {
    listen 80;
    server_name api.zuo2799662352.xyz update.zuo2799662352.xyz;
    
    location / {
        proxy_pass http://api:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF
```

### æ­¥éª¤7: å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨PostgreSQL
docker-compose up -d postgres
sleep 10

# å¯åŠ¨API
docker-compose up -d --build api
sleep 10

# å¯åŠ¨Nginx
docker-compose up -d nginx

# æŸ¥çœ‹çŠ¶æ€
docker-compose ps
```

---

## ðŸ” é…ç½®SSLè¯ä¹¦ï¼ˆå¯é€‰ï¼‰

### å‰æï¼šDNSå·²é…ç½®å¹¶ç”Ÿæ•ˆ

**æ‰§è¡ŒSSLé…ç½®è„šæœ¬ï¼š**

```bash
cd /opt/sora-ui-deploy

# åœæ­¢Nginx
docker-compose stop nginx

# ç”³è¯·SSLè¯ä¹¦
docker run --rm \
  -v /opt/sora-ui-deploy/certbot/conf:/etc/letsencrypt \
  -v /opt/sora-ui-deploy/certbot/www:/var/www/certbot \
  -p 80:80 \
  certbot/certbot certonly \
  --standalone \
  --non-interactive \
  --email zuozuoliang999@gmail.com \
  --agree-tos \
  --no-eff-email \
  --force-renewal \
  -d api.zuo2799662352.xyz \
  -d update.zuo2799662352.xyz

# å¦‚æžœæˆåŠŸï¼Œæ›´æ–°Nginxé…ç½®ä¸ºHTTPS
cat > nginx/conf.d/default.conf << 'EOF'
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name api.zuo2799662352.xyz update.zuo2799662352.xyz;
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS API
server {
    listen 443 ssl http2;
    server_name api.zuo2799662352.xyz;
    
    ssl_certificate /etc/letsencrypt/live/api.zuo2799662352.xyz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.zuo2799662352.xyz/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    location / {
        proxy_pass http://api:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# HTTPS Update
server {
    listen 443 ssl http2;
    server_name update.zuo2799662352.xyz;
    
    ssl_certificate /etc/letsencrypt/live/api.zuo2799662352.xyz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.zuo2799662352.xyz/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    root /usr/share/nginx/html/updates;
    autoindex on;
}
EOF

# é‡å¯Nginx
docker-compose up -d nginx

# æ·»åŠ è‡ªåŠ¨ç»­æœŸ
docker-compose up -d certbot
```

---

## ðŸ§ª æµ‹è¯•éƒ¨ç½²

### æœ¬åœ°æµ‹è¯•ï¼ˆWindows PowerShellï¼‰ï¼š

```powershell
# æµ‹è¯•HTTP
Invoke-RestMethod -Uri "http://api.zuo2799662352.xyz/health"

# æµ‹è¯•HTTPSï¼ˆå¦‚æžœå·²é…ç½®ï¼‰
Invoke-RestMethod -Uri "https://api.zuo2799662352.xyz/health"

# æµ‹è¯•ç™»å½•
$body = @{
    username = "admin"
    password = "admin123"
} | ConvertTo-Json

Invoke-RestMethod -Uri "https://api.zuo2799662352.xyz/api/auth/login" `
    -Method Post `
    -ContentType "application/json" `
    -Body $body
```

### æœåŠ¡å™¨æµ‹è¯•ï¼š

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose ps
```

---

## ðŸ“‹ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æ—¥å¿—
```bash
# æ‰€æœ‰æœåŠ¡
docker-compose logs -f

# ç‰¹å®šæœåŠ¡
docker-compose logs -f api
docker-compose logs -f postgres
docker-compose logs -f nginx
```

### é‡å¯æœåŠ¡
```bash
# é‡å¯æ‰€æœ‰
docker-compose restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart api
```

### åœæ­¢æœåŠ¡
```bash
docker-compose down
```

### æ›´æ–°ä»£ç 
```bash
# ä¸Šä¼ æ–°ä»£ç ï¼ˆæœ¬åœ°æ‰§è¡Œï¼‰
rsync -avz --exclude 'node_modules' ./ ubuntu@175.27.250.155:/opt/sora-ui-deploy/backend/

# é‡æ–°æž„å»ºå¹¶å¯åŠ¨ï¼ˆæœåŠ¡å™¨æ‰§è¡Œï¼‰
cd /opt/sora-ui-deploy
docker-compose up -d --build api
```

---

## ðŸ”§ æ•…éšœæŽ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs api

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep 3001

# é‡æ–°æž„å»º
docker-compose up -d --build --force-recreate api
```

### æ•°æ®åº“è¿žæŽ¥å¤±è´¥

```bash
# æ£€æŸ¥PostgreSQLçŠ¶æ€
docker-compose ps postgres

# æµ‹è¯•æ•°æ®åº“è¿žæŽ¥
docker exec -it sora-postgres psql -U sorauser -d sora_ui -c "SELECT version();"
```

### SSLè¯ä¹¦é—®é¢˜

```bash
# æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…
docker run --rm -v /opt/sora-ui-deploy/certbot/conf:/etc/letsencrypt certbot/certbot certificates

# æ‰‹åŠ¨ç»­æœŸ
docker-compose stop nginx
docker run --rm -v /opt/sora-ui-deploy/certbot/conf:/etc/letsencrypt -p 80:80 certbot/certbot renew
docker-compose up -d nginx
```

---

## ðŸ“Š é¡¹ç›®æ–‡ä»¶ç»“æž„

```
/opt/sora-ui-deploy/
â”œâ”€â”€ backend/              # åŽç«¯æºä»£ç 
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ nginx/
â”‚   â””â”€â”€ conf.d/
â”‚       â””â”€â”€ default.conf  # Nginxé…ç½®
â”œâ”€â”€ certbot/
â”‚   â”œâ”€â”€ conf/            # SSLè¯ä¹¦
â”‚   â””â”€â”€ www/             # ACMEéªŒè¯
â”œâ”€â”€ logs/                # åº”ç”¨æ—¥å¿—
â”œâ”€â”€ updates/             # æ›´æ–°æ–‡ä»¶
â”œâ”€â”€ postgres-data/       # æ•°æ®åº“æ•°æ®
â””â”€â”€ docker-compose.yml   # Dockerç¼–æŽ’æ–‡ä»¶
```

---

## ðŸŽ¯ ä¸‹ä¸€æ­¥

1. âœ… å®ŒæˆåŸºç¡€éƒ¨ç½²
2. âœ… é…ç½®SSLè¯ä¹¦ï¼ˆå¯é€‰ï¼‰
3. âœ… æµ‹è¯•æ‰€æœ‰æŽ¥å£
4. â³ é…ç½®æ•°æ®åº“å¤‡ä»½
5. â³ é…ç½®ç›‘æŽ§å‘Šè­¦
6. â³ ä¼˜åŒ–æ€§èƒ½é…ç½®

---

## ðŸ“š å‚è€ƒæ–‡æ¡£

- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [Let's Encrypt æ–‡æ¡£](https://letsencrypt.org/docs/)
- [Nginx å®˜æ–¹æ–‡æ¡£](https://nginx.org/en/docs/)

---

**éœ€è¦å¸®åŠ©ï¼Ÿ**
- æŸ¥çœ‹ `è…¾è®¯äº‘Dockeréƒ¨ç½²æ–¹æ¡ˆ.md` èŽ·å–è¯¦ç»†è¯´æ˜Ž
- æŸ¥çœ‹ `SSL.MD` äº†è§£SSLé…ç½®è¯¦æƒ…

**ç‰ˆæœ¬**: v1.0  
**æœ€åŽæ›´æ–°**: 2025-11-06




























































































































































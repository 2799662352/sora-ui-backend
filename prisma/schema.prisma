// ğŸ”¥ Sora UI Backend - ç²¾ç®€ç‰ˆ Prisma Schema
// éµå¾ªåŸåˆ™ï¼šKISSï¼ˆKeep It Simpleï¼‰ã€DRYã€Low Coupling
// ä¼˜åŒ–ç›®æ ‡ï¼šåªå­˜å‚¨æ ¸å¿ƒIDæ˜ å°„å’ŒçŠ¶æ€ï¼Œå¤§é¢æ•°æ®ç”±å‰ç«¯æœ¬åœ°å­˜å‚¨

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // ğŸ”¥ ä¼˜åŒ–ï¼šè¿æ¥æ± é…ç½®ï¼ˆå‚è€ƒ Prisma æœ€ä½³å®è·µï¼‰
  // connection_limit: æœ€å¤§è¿æ¥æ•°
  // pool_timeout: è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
  // ç”Ÿäº§ç¯å¢ƒé€šè¿‡ DATABASE_URL å‚æ•°é…ç½®ï¼š
  // postgresql://user:pass@host:5432/db?connection_limit=20&pool_timeout=10
}

// ============ ç”¨æˆ·è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String?  @unique
  password  String
  avatar    String?  // ç”¨æˆ·å¤´åƒURL
  
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  license   License?
  logs      ActivityLog[]
  videoTasks VideoTask[]
  channels  Channel[]  // ğŸ”¥ API Channel ç®¡ç†
  
  // ğŸ”¥ åä½œç³»ç»Ÿå…³è”
  ownedTeams     Team[]        @relation("TeamOwner")
  teamMemberships TeamMember[]
  createdTasks   CollabTask[]  @relation("TaskCreator")
  assignedTasks  CollabTask[]  @relation("TaskAssignee")
  reviewedTasks  CollabTask[]  @relation("TaskReviewer")
  taskComments   TaskComment[]
  taskAttachments TaskAttachment[]
  taskHistory    TaskHistory[]
  notifications  Notification[]
  generationTasks GenerationTask[]  // ğŸ†• ç”Ÿæˆä»»åŠ¡
  
  @@index([email])
  @@index([username])
  @@map("User")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ============ è®¸å¯è¯è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model License {
  id          String       @id @default(uuid())
  licenseKey  String       @unique
  type        LicenseType
  
  userId      String?      @unique
  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  isActive    Boolean      @default(true)
  deviceId    String?
  features    Json         @default("{}")
  
  activatedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([licenseKey])
  @@index([userId])
  @@map("License")
}

enum LicenseType {
  TRIAL
  PRO
  ENTERPRISE
}

// ============ æ´»åŠ¨æ—¥å¿—è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action    String
  details   Json     @default("{}")
  
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("ActivityLog")
}

// ============ ç³»ç»Ÿé…ç½®è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("SystemConfig")
}

// ============ ğŸ”¥ è§†é¢‘ä»»åŠ¡è¡¨ï¼ˆå…¼å®¹ç‰ˆï¼šæ–°æ—§æ¨¡å¼å…±å­˜ï¼‰ ============
model VideoTask {
  id              String       @id @default(uuid())
  videoId         String       @unique  // å†…éƒ¨è§†é¢‘ ID
  externalTaskId  String?              // ğŸ”¥ æ–°å­—æ®µï¼šå¤–éƒ¨ API çš„ä»»åŠ¡ ID
  clientRequestId String?              // ğŸ”¥ BUG-003 ä¿®å¤ï¼šå‰ç«¯ä»»åŠ¡ IDï¼Œç”¨äºå…³è”æœ¬åœ°ä»»åŠ¡å’Œåç«¯ä»»åŠ¡
  
  // ç”¨æˆ·å…³è”
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ğŸ”¥ æ ¸å¿ƒçŠ¶æ€ä¿¡æ¯
  status          TaskStatus   @default(QUEUED)
  progress        Int          @default(0)  // 0-100
  
  // ğŸ”¥ åŸºæœ¬ä¿¡æ¯
  model           String                    // æ¨¡å‹åç§°
  apiConfigId     String?                   // API é…ç½® ID
  mediaType       MediaType    @default(VIDEO)
  
  // ğŸ”¥ æ–°å­—æ®µï¼šPrompt æ‘˜è¦ï¼ˆç²¾ç®€æ¨¡å¼ï¼‰
  promptHash      String?                   // Prompt Hashï¼ˆå»é‡ï¼‰
  promptPreview   String?      @db.VarChar(200) // Prompt é¢„è§ˆ
  
  // ğŸ”¥ æ—§å­—æ®µï¼šå®Œæ•´æ•°æ®ï¼ˆæ—§æ¨¡å¼å…¼å®¹ï¼‰
  prompt          String?      @db.Text    // å®Œæ•´ Promptï¼ˆæ—§æ¨¡å¼ï¼‰
  referenceImage  String?      @db.Text    // å‚è€ƒå›¾ç‰‡ï¼ˆæ—§æ¨¡å¼ï¼‰
  videoUrl        String?      @db.Text    // è§†é¢‘URLï¼ˆæ—§æ¨¡å¼ï¼‰
  imageUrl        String?      @db.Text    // å›¾ç‰‡URL
  size            String?                  // å°ºå¯¸
  duration        Int?                     // æ—¶é•¿
  aspectRatio     String?                  // å®½é«˜æ¯”
  watermark       Boolean      @default(false)
  
  // ğŸ”¥ æ—§å­—æ®µï¼šå¼‚æ­¥ä»»åŠ¡ç›¸å…³
  isAsync         Boolean      @default(false)
  apiEndpoint     String?
  pollCount       Int          @default(0)
  startedAt       DateTime?
  lastPollTime    DateTime?
  
  // ğŸ”¥ æ—§å­—æ®µï¼šMetadataï¼ˆå…¼å®¹ï¼‰
  metadata        Json?        @db.JsonB
  
  // ğŸ”¥ é”™è¯¯ä¿¡æ¯
  errorCode       String?
  errorMessage    String?      @db.Text
  
  // ğŸ”¥ æ—¶é—´æˆ³
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?
  
  // ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
  @@index([videoId])
  @@index([externalTaskId])
  @@index([clientRequestId])  // ğŸ”¥ BUG-003 ä¿®å¤ï¼šæ”¯æŒé€šè¿‡å‰ç«¯ä»»åŠ¡ ID æŸ¥è¯¢
  @@index([userId, status])
  @@index([status, createdAt])
  @@index([promptHash])
  @@map("VideoTask")
}

enum TaskStatus {
  QUEUED      // æ’é˜Ÿä¸­
  PROCESSING  // å¤„ç†ä¸­
  COMPLETED   // å·²å®Œæˆ
  FAILED      // å¤±è´¥
  CANCELLED   // å·²å–æ¶ˆ
}

enum MediaType {
  VIDEO       // è§†é¢‘
  IMAGE       // å›¾ç‰‡
}

// ============ ğŸ”¥ API Channel è¡¨ï¼ˆå¢å¼ºç‰ˆ - å®Œå…¨å‚è€ƒ LiteLLMï¼‰ ============
model Channel {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  
  // åŸºæœ¬ä¿¡æ¯
  name        String
  type        String   // 'openai', 'azure', 'sora', 'custom'
  baseURL     String   @map("base_url")
  apiKey      String   @map("api_key")
  
  // æ¨¡å‹æ”¯æŒ
  models      String[] // æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
  
  // è´Ÿè½½å‡è¡¡
  priority    Int      @default(1)  // æƒé‡ï¼ˆ1-100ï¼‰
  status      String   @default("active")  // 'active', 'disabled'
  groupName   String?  @map("group_name")  // åˆ†ç»„åç§°
  
  // ğŸ”¥ LiteLLM: é™æµï¼ˆå¤šç»´åº¦ï¼‰
  rateLimit   Int?     @map("rate_limit")       // RPM é™åˆ¶
  tpmLimit    BigInt?  @map("tpm_limit")        // TPM é™åˆ¶ï¼ˆTokens Per Minuteï¼‰
  maxParallelReqs Int? @map("max_parallel_reqs")// æœ€å¤§å¹¶å‘è¯·æ±‚
  
  // ğŸ”¥ LiteLLM: æˆæœ¬ç»Ÿè®¡ï¼ˆè¯¦ç»†ï¼‰
  totalCost      Float    @default(0) @map("total_cost")    // æ€»æˆæœ¬
  spendToday     Float    @default(0) @map("spend_today")   // ä»Šæ—¥æ¶ˆè´¹
  spendThisMonth Float    @default(0) @map("spend_month")   // æœ¬æœˆæ¶ˆè´¹
  modelSpend     Json?    @default("{}") @map("model_spend")// æŒ‰æ¨¡å‹ç»Ÿè®¡ {"gpt-4": 123.45}
  
  // ğŸ”¥ LiteLLM: é¢„ç®—ç®¡ç†
  maxBudget      Float?   @map("max_budget")                // æœ€å¤§é¢„ç®—
  softBudget     Float?   @map("soft_budget")               // è½¯é¢„ç®—ï¼ˆè­¦å‘Šï¼‰
  budgetResetAt  DateTime? @map("budget_reset_at")          // é¢„ç®—é‡ç½®æ—¶é—´
  
  // ğŸ”¥ LiteLLM: å¥åº·çŠ¶æ€ï¼ˆCooldownæœºåˆ¶ï¼‰
  isHealthy      Boolean  @default(true) @map("is_healthy") // æ˜¯å¦å¥åº·
  failureCount   Int      @default(0) @map("failure_count") // è¿ç»­å¤±è´¥æ¬¡æ•°
  cooldownUntil  DateTime? @map("cooldown_until")           // å†·å´æœŸç»“æŸæ—¶é—´
  lastFailedAt   DateTime? @map("last_failed_at")           // æœ€åå¤±è´¥æ—¶é—´
  
  // ğŸ”¥ LiteLLM: æ€§èƒ½æŒ‡æ ‡
  avgLatencyMs   Int?     @map("avg_latency_ms")            // å¹³å‡å»¶è¿Ÿ
  successRate    Float    @default(1.0) @map("success_rate")// æˆåŠŸç‡ï¼ˆ0-1ï¼‰
  activeRequests Int      @default(0) @map("active_requests")// å½“å‰æ´»è·ƒè¯·æ±‚æ•°
  
  // ç»Ÿè®¡
  totalCalls  Int      @default(0) @map("total_calls")
  lastUsedAt  DateTime? @map("last_used_at")
  
  // ğŸ”¥ LiteLLM: çµæ´»å…ƒæ•°æ®
  metadata    Json?    @default("{}") // æ‰©å±•å­—æ®µ
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // å…³è”
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  requestLogs RequestLog[]  // ğŸ”¥ æ–°å¢ï¼šè¯·æ±‚æ—¥å¿—å…³è”
  
  // ç´¢å¼•
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([groupName])
  @@index([isHealthy])  // ğŸ”¥ æ–°å¢ï¼šå¥åº·çŠ¶æ€ç´¢å¼•
  @@map("Channel")
}

// ============ ğŸ”¥ è¯·æ±‚æ—¥å¿—è¡¨ï¼ˆæ–°å¢ - å‚è€ƒ LiteLLM SpendLogsï¼‰ ============
model RequestLog {
  id                String   @id @default(uuid())
  requestId         String   @unique @map("request_id")       // è¯·æ±‚å”¯ä¸€ID
  
  // å…³è”
  channelId         String   @map("channel_id")
  userId            String   @map("user_id")
  channel           Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  // ğŸ”¥ LiteLLM: è¯·æ±‚ä¿¡æ¯
  model             String                                     // æ¨¡å‹åç§°
  modelGroup        String?  @map("model_group")              // æ¨¡å‹ç»„
  callType          String   @default("completion") @map("call_type") // completion/embedding/chat
  customProvider    String?  @map("custom_provider")          // è‡ªå®šä¹‰æä¾›å•†
  
  // ğŸ”¥ LiteLLM: æˆæœ¬å’ŒToken
  spend             Float    @default(0.0)                    // æœ¬æ¬¡è¯·æ±‚æˆæœ¬
  totalTokens       Int      @default(0) @map("total_tokens")
  promptTokens      Int      @default(0) @map("prompt_tokens")
  completionTokens  Int      @default(0) @map("completion_tokens")
  
  // ğŸ”¥ LiteLLM: æ—¶é—´è¿½è¸ª
  startTime         DateTime @map("start_time")               // è¯·æ±‚å¼€å§‹
  endTime           DateTime @map("end_time")                 // è¯·æ±‚ç»“æŸ
  responseTimeMs    Int?     @map("response_time_ms")         // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  
  // ğŸ”¥ çŠ¶æ€
  status            String   @default("success")              // success/error
  errorMessage      String?  @db.Text @map("error_message")
  httpStatus        Int?     @map("http_status")              // HTTPçŠ¶æ€ç 
  
  // ğŸ”¥ LiteLLM: å…ƒæ•°æ®
  metadata          Json?    @default("{}")                   // æ‰©å±•ä¿¡æ¯
  
  // æ—¶é—´æˆ³
  createdAt         DateTime @default(now()) @map("created_at")
  
  // ç´¢å¼•ï¼ˆé‡è¦ï¼æŸ¥è¯¢æ€§èƒ½ï¼‰
  @@index([channelId])
  @@index([userId])
  @@index([model])
  @@index([startTime])
  @@index([status])
  @@map("RequestLog")
}

// ============ ğŸ”¥ åä½œç³»ç»Ÿè¡¨ ============

// å›¢é˜Ÿ/é¡¹ç›®è¡¨
model Team {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  avatar      String?  // å›¢é˜Ÿå¤´åƒURL
  
  // åˆ›å»ºè€…ï¼ˆå¯¼æ¼”ï¼‰
  ownerId     String   @map("owner_id")
  owner       User     @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // çŠ¶æ€
  status      TeamStatus @default(ACTIVE)
  
  // è®¾ç½®
  settings    Json     @default("{}")  // å›¢é˜Ÿé…ç½®ï¼šé€šçŸ¥åå¥½ã€æƒé™ç­‰
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // å…³è”
  members     TeamMember[]
  projects    Project[]
  
  @@index([ownerId])
  @@index([status])
  @@map("Team")
}

enum TeamStatus {
  ACTIVE
  ARCHIVED
  SUSPENDED
}

// å›¢é˜Ÿæˆå‘˜è¡¨ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
model TeamMember {
  id        String   @id @default(uuid())
  
  teamId    String   @map("team_id")
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // è§’è‰²
  role      MemberRole @default(MEMBER)
  
  // çŠ¶æ€
  status    MemberStatus @default(ACTIVE)
  
  // åŠ å…¥ä¿¡æ¯
  invitedBy String?  @map("invited_by")
  joinedAt  DateTime @default(now()) @map("joined_at")
  
  // æ—¶é—´æˆ³
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@index([role])
  @@map("TeamMember")
}

enum MemberRole {
  DIRECTOR    // å¯¼æ¼”ï¼šæœ€é«˜æƒé™ï¼Œå¯ä»¥ç®¡ç†æ‰€æœ‰æˆå‘˜å’Œä»»åŠ¡
  LEAD        // ç»„é•¿ï¼šå¯ä»¥ç®¡ç†åˆ†é…ç»™è‡ªå·±ç»„çš„ä»»åŠ¡
  MEMBER      // ç»„å‘˜ï¼šåªèƒ½ç¼–è¾‘å’Œæäº¤è‡ªå·±çš„ä»»åŠ¡
  VIEWER      // è§‚å¯Ÿè€…ï¼šåªè¯»æƒé™
}

enum MemberStatus {
  ACTIVE
  INVITED
  SUSPENDED
  LEFT
}

// é¡¹ç›®è¡¨
model Project {
  id          String   @id @default(uuid())
  
  // æ‰€å±å›¢é˜Ÿ
  teamId      String   @map("team_id")
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  // åŸºæœ¬ä¿¡æ¯
  name        String
  description String?  @db.Text
  cover       String?  // å°é¢å›¾URL
  
  // çŠ¶æ€
  status      ProjectStatus @default(PLANNING)
  priority    Int      @default(1)  // 1-5ï¼Œ5æœ€é«˜
  
  // æ—¶é—´è§„åˆ’
  startDate   DateTime? @map("start_date")
  dueDate     DateTime? @map("due_date")
  
  // è¿›åº¦ç»Ÿè®¡ï¼ˆç¼“å­˜ï¼‰
  totalTasks  Int      @default(0) @map("total_tasks")
  completedTasks Int   @default(0) @map("completed_tasks")
  progress    Float    @default(0)  // 0-100
  
  // è®¾ç½®
  settings    Json     @default("{}")
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // å…³è”
  tasks       CollabTask[]
  milestones  Milestone[]
  
  // ğŸ¬ åˆ›ä½œèµ„æºå…³è”
  episodes    Episode[]
  characters  Character[]
  scenes      Scene[]
  items       Item[]
  generationTasks GenerationTask[]  // ğŸ†• ç”Ÿæˆä»»åŠ¡
  
  @@index([teamId])
  @@index([status])
  @@index([priority])
  @@map("Project")
}

enum ProjectStatus {
  PLANNING    // è§„åˆ’ä¸­
  IN_PROGRESS // è¿›è¡Œä¸­
  ON_HOLD     // æš‚åœ
  COMPLETED   // å·²å®Œæˆ
  CANCELLED   // å·²å–æ¶ˆ
}

// é‡Œç¨‹ç¢‘è¡¨
model Milestone {
  id          String   @id @default(uuid())
  
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // åŸºæœ¬ä¿¡æ¯
  name        String
  description String?  @db.Text
  
  // çŠ¶æ€
  status      MilestoneStatus @default(PENDING)
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  
  // æ’åº
  sortOrder   Int      @default(0) @map("sort_order")
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // å…³è”
  tasks       CollabTask[]
  
  @@index([projectId])
  @@index([status])
  @@map("Milestone")
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

// åä½œä»»åŠ¡è¡¨
model CollabTask {
  id          String   @id @default(uuid())
  
  // æ‰€å±é¡¹ç›®
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // å¯é€‰é‡Œç¨‹ç¢‘
  milestoneId String?  @map("milestone_id")
  milestone   Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  
  // ä»»åŠ¡åˆ†é…
  assigneeId  String?  @map("assignee_id")
  assignee    User?    @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  
  createdById String   @map("created_by_id")
  createdBy   User     @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  // åŸºæœ¬ä¿¡æ¯
  title       String
  description String?  @db.Text
  
  // ä»»åŠ¡ç±»å‹
  taskType    TaskType @default(GENERAL) @map("task_type")
  
  // çŠ¶æ€ä¸ä¼˜å…ˆçº§
  status      TaskItemStatus @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  
  // æ—¶é—´è§„åˆ’
  startDate   DateTime? @map("start_date")
  dueDate     DateTime? @map("due_date")
  estimatedHours Float?  @map("estimated_hours")
  actualHours Float?   @map("actual_hours")
  
  // è¿›åº¦
  progress    Int      @default(0)  // 0-100
  
  // æäº¤å†…å®¹ï¼ˆURLç­‰ï¼‰
  submissionUrl String?  @db.Text @map("submission_url")
  submissionNote String? @db.Text @map("submission_note")
  submittedAt DateTime? @map("submitted_at")
  
  // å®¡æ ¸ä¿¡æ¯
  reviewStatus ReviewStatus? @map("review_status")
  reviewerId  String?  @map("reviewer_id")
  reviewer    User?    @relation("TaskReviewer", fields: [reviewerId], references: [id], onDelete: SetNull)
  reviewNote  String?  @db.Text @map("review_note")
  reviewedAt  DateTime? @map("reviewed_at")
  
  // æ ‡ç­¾ï¼ˆJSONæ•°ç»„ï¼‰
  tags        String[] @default([])
  
  // æ’åº
  sortOrder   Int      @default(0) @map("sort_order")
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")
  
  // å…³è”
  comments    TaskComment[]
  attachments TaskAttachment[]
  history     TaskHistory[]
  
  @@index([projectId])
  @@index([milestoneId])
  @@index([assigneeId])
  @@index([createdById])
  @@index([status])
  @@index([priority])
  @@index([reviewStatus])
  @@map("CollabTask")
}

enum TaskType {
  GENERAL     // é€šç”¨ä»»åŠ¡
  VIDEO       // è§†é¢‘åˆ¶ä½œ
  DESIGN      // è®¾è®¡
  WRITING     // æ–‡æ¡ˆ
  REVIEW      // å®¡æ ¸
  BUG         // Bugä¿®å¤
  FEATURE     // åŠŸèƒ½å¼€å‘
}

enum TaskItemStatus {
  TODO        // å¾…åŠ
  IN_PROGRESS // è¿›è¡Œä¸­
  SUBMITTED   // å·²æäº¤
  IN_REVIEW   // å®¡æ ¸ä¸­
  REVISION    // éœ€ä¿®æ”¹
  DONE        // å®Œæˆ
  BLOCKED     // é˜»å¡
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ReviewStatus {
  PENDING     // å¾…å®¡æ ¸
  APPROVED    // å·²é€šè¿‡
  REJECTED    // å·²æ‹’ç»
  NEEDS_REVISION // éœ€ä¿®æ”¹
}

// ä»»åŠ¡è¯„è®ºè¡¨
model TaskComment {
  id        String   @id @default(uuid())
  
  taskId    String   @map("task_id")
  task      CollabTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  authorId  String   @map("author_id")
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  // è¯„è®ºå†…å®¹
  content   String   @db.Text
  
  // è¯„è®ºç±»å‹
  type      CommentType @default(COMMENT)
  
  // çˆ¶è¯„è®ºï¼ˆå›å¤åŠŸèƒ½ï¼‰
  parentId  String?  @map("parent_id")
  parent    TaskComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies   TaskComment[] @relation("CommentReplies")
  
  // æ—¶é—´æˆ³
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([taskId])
  @@index([authorId])
  @@index([parentId])
  @@map("TaskComment")
}

enum CommentType {
  COMMENT     // æ™®é€šè¯„è®º
  INSTRUCTION // å¯¼æ¼”æŒ‡ä»¤
  FEEDBACK    // åé¦ˆ
  REVISION    // ä¿®æ”¹å»ºè®®
}

// ä»»åŠ¡é™„ä»¶è¡¨
model TaskAttachment {
  id        String   @id @default(uuid())
  
  taskId    String   @map("task_id")
  task      CollabTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  uploaderId String  @map("uploader_id")
  uploader  User     @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  
  // æ–‡ä»¶ä¿¡æ¯
  filename  String
  url       String   @db.Text
  fileType  String   @map("file_type")  // MIME type
  fileSize  Int      @map("file_size")  // bytes
  
  // æ—¶é—´æˆ³
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([taskId])
  @@index([uploaderId])
  @@map("TaskAttachment")
}

// ä»»åŠ¡å†å²è®°å½•è¡¨
model TaskHistory {
  id        String   @id @default(uuid())
  
  taskId    String   @map("task_id")
  task      CollabTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  actorId   String   @map("actor_id")
  actor     User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  
  // å˜æ›´ä¿¡æ¯
  action    String   // created, updated, status_changed, assigned, reviewed, etc.
  field     String?  // å˜æ›´çš„å­—æ®µå
  oldValue  String?  @db.Text @map("old_value")
  newValue  String?  @db.Text @map("new_value")
  
  // æ—¶é—´æˆ³
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([taskId])
  @@index([actorId])
  @@index([createdAt])
  @@map("TaskHistory")
}

// é€šçŸ¥è¡¨
model Notification {
  id        String   @id @default(uuid())
  
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // é€šçŸ¥å†…å®¹
  type      NotificationType
  title     String
  content   String   @db.Text
  
  // å…³è”å®ä½“
  entityType String?  @map("entity_type")  // team, project, task, comment
  entityId  String?  @map("entity_id")
  
  // å‘é€è€…
  senderId  String?  @map("sender_id")
  
  // çŠ¶æ€
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  
  // æ—¶é—´æˆ³
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("Notification")
}

enum NotificationType {
  TASK_ASSIGNED     // ä»»åŠ¡è¢«åˆ†é…
  TASK_SUBMITTED    // ä»»åŠ¡å·²æäº¤
  TASK_REVIEWED     // ä»»åŠ¡è¢«å®¡æ ¸
  TASK_COMMENTED    // ä»»åŠ¡è¢«è¯„è®º
  TASK_UPDATED      // ä»»åŠ¡è¢«æ›´æ–°
  TASK_DUE_SOON     // ä»»åŠ¡å³å°†åˆ°æœŸ
  PROJECT_UPDATED   // é¡¹ç›®æ›´æ–°
  TEAM_INVITATION   // å›¢é˜Ÿé‚€è¯·
  MENTION           // è¢«@æåŠ
  SYSTEM            // ç³»ç»Ÿé€šçŸ¥
}

// ============ ğŸ¬ åˆ›ä½œèµ„æºæ¨¡å‹ï¼ˆå·¨æ—¥ç¦„é£æ ¼ï¼‰ ============

// ç‰‡æ®µ/åˆ†é•œè¡¨ï¼ˆJurilu: ç‰‡æ®µç®¡ç†ï¼‰
model Episode {
  id          String   @id @default(uuid())
  
  // æ‰€å±é¡¹ç›®
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // åŸºæœ¬ä¿¡æ¯
  name        String
  description String?  @db.Text
  
  // çŠ¶æ€
  status      EpisodeStatus @default(DRAFT)
  
  // æ—¶é•¿ï¼ˆç§’ï¼‰
  duration    Int?     // é¢„è®¡æ—¶é•¿
  
  // æ’åº
  sortOrder   Int      @default(0) @map("sort_order")
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([projectId])
  @@index([status])
  @@index([sortOrder])
  @@map("Episode")
}

enum EpisodeStatus {
  DRAFT       // è‰ç¨¿
  IN_PROGRESS // åˆ¶ä½œä¸­
  REVIEW      // å®¡æ ¸ä¸­
  COMPLETED   // å·²å®Œæˆ
}

// è§’è‰²è¡¨ï¼ˆJurilu: è§’è‰²ç®¡ç†ï¼‰
model Character {
  id          String   @id @default(uuid())
  
  // æ‰€å±é¡¹ç›®
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // åŸºæœ¬ä¿¡æ¯
  name        String
  description String?  @db.Text
  
  // è§’è‰²å±æ€§
  personality String?  @db.Text    // æ€§æ ¼æè¿°
  appearance  String?  @db.Text    // å¤–è²Œæè¿°
  
  // ç”Ÿæˆç›¸å…³
  referenceImage String? @db.Text @map("reference_image")  // å‚è€ƒå›¾ URL
  generatedImages String[] @default([]) @map("generated_images")  // ç”Ÿæˆçš„å›¾ç‰‡åˆ—è¡¨
  confirmedImage String? @map("confirmed_image")  // ç¡®è®¤ä½¿ç”¨çš„å›¾ç‰‡
  
  // çŠ¶æ€
  status      ResourceStatus @default(DRAFT)
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([projectId])
  @@index([status])
  @@map("Character")
}

// åœºæ™¯è¡¨ï¼ˆJurilu: åœºæ™¯ç®¡ç†ï¼‰
model Scene {
  id          String   @id @default(uuid())
  
  // æ‰€å±é¡¹ç›®
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // åŸºæœ¬ä¿¡æ¯
  name        String
  description String?  @db.Text
  
  // åœºæ™¯å±æ€§
  location    String?              // åœ°ç‚¹
  timeOfDay   String?  @map("time_of_day")  // æ—¶é—´ï¼ˆç™½å¤©/é»„æ˜/å¤œæ™šç­‰ï¼‰
  weather     String?              // å¤©æ°”
  
  // ç”Ÿæˆç›¸å…³
  referenceImage String? @db.Text @map("reference_image")
  generatedImages String[] @default([]) @map("generated_images")
  confirmedImage String? @map("confirmed_image")
  
  // çŠ¶æ€
  status      ResourceStatus @default(DRAFT)
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([projectId])
  @@index([status])
  @@map("Scene")
}

// é“å…·/ç‰©å“è¡¨ï¼ˆJurilu: ç‰©å“ç®¡ç†ï¼‰
model Item {
  id          String   @id @default(uuid())
  
  // æ‰€å±é¡¹ç›®
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // åŸºæœ¬ä¿¡æ¯
  name        String
  description String?  @db.Text
  category    String?              // åˆ†ç±»ï¼ˆæ­¦å™¨/é“å…·/æœè£…ç­‰ï¼‰
  
  // å±æ€§
  properties  Json?    @default("{}")  // è‡ªå®šä¹‰å±æ€§
  
  // ç”Ÿæˆç›¸å…³
  referenceImage String? @db.Text @map("reference_image")
  generatedImages String[] @default([]) @map("generated_images")
  confirmedImage String? @map("confirmed_image")
  
  // çŠ¶æ€
  status      ResourceStatus @default(DRAFT)
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([projectId])
  @@index([status])
  @@index([category])
  @@map("Item")
}

// èµ„æºçŠ¶æ€æšä¸¾ï¼ˆè§’è‰²/åœºæ™¯/ç‰©å“å…±ç”¨ï¼‰
enum ResourceStatus {
  DRAFT       // è‰ç¨¿
  GENERATING  // ç”Ÿæˆä¸­
  PREVIEW     // å¾…ç¡®è®¤
  CONFIRMED   // å·²ç¡®è®¤
}

// ============ ğŸ”¥ ç”Ÿæˆä»»åŠ¡ (EpisodeWorkbench æ ¸å¿ƒ) ============

model GenerationTask {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // å…³è”èµ„æº
  resourceType   GenerationResourceType @map("resource_type")
  resourceId     String?    @map("resource_id")     // å…³è”çš„è§’è‰²/åœºæ™¯/ç‰©å“ ID
  resourceName   String?    @map("resource_name")   // å†—ä½™å­˜å‚¨ï¼Œæ–¹ä¾¿æŸ¥è¯¢
  episodeId      String?    @map("episode_id")      // å…³è”çš„ç‰‡æ®µ ID
  
  // AI æ¨¡å‹å’Œå‚æ•°
  aiModel        String     @map("ai_model")        // ä½¿ç”¨çš„ AI æ¨¡å‹
  prompt         String     @db.Text                // ç”Ÿæˆæç¤ºè¯
  referenceImage String?    @db.Text @map("reference_image") // å‚è€ƒå›¾ç‰‡ URL
  
  // ç”Ÿæˆå‚æ•° (JSON å­˜å‚¨çµæ´»å‚æ•°)
  params         Json?      @default("{}")          // åˆ†è¾¨ç‡/æ•°é‡/é£æ ¼ç­‰
  
  // ç”Ÿæˆç»“æœ
  status         GenerationTaskStatus @default(PENDING)
  candidateImages String[]  @default([]) @map("candidate_images") // å€™é€‰ç»“æœ
  confirmedImage  String?   @map("confirmed_image")  // ç¡®è®¤çš„ç»“æœ
  errorMessage    String?   @db.Text @map("error_message")
  
  // å¤–éƒ¨ä»»åŠ¡è¿½è¸ª
  externalTaskId String?    @map("external_task_id") // å¤–éƒ¨ API ä»»åŠ¡ ID
  
  // ç§¯åˆ†æ¶ˆè€—
  creditsUsed    Int        @default(0) @map("credits_used")
  
  // åˆ›å»ºè€…
  createdById    String     @map("created_by_id")
  createdBy      User       @relation(fields: [createdById], references: [id])
  
  // æ—¶é—´æˆ³
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  completedAt    DateTime?  @map("completed_at")
  
  @@index([projectId])
  @@index([status])
  @@index([resourceType])
  @@index([createdById])
  @@map("GenerationTask")
}

// ç”Ÿæˆèµ„æºç±»å‹
enum GenerationResourceType {
  CHARACTER   // è§’è‰²å›¾ç‰‡
  SCENE       // åœºæ™¯å›¾ç‰‡
  ITEM        // ç‰©å“å›¾ç‰‡
  VIDEO       // è§†é¢‘ç”Ÿæˆ
  FUSION      // èåˆç”Ÿå›¾
}

// ç”Ÿæˆä»»åŠ¡çŠ¶æ€
enum GenerationTaskStatus {
  PENDING     // ç­‰å¾…å¤„ç†
  QUEUED      // å·²å…¥é˜Ÿ
  PROCESSING  // ç”Ÿæˆä¸­
  PREVIEW     // å¾…ç¡®è®¤ï¼ˆæœ‰å€™é€‰ç»“æœï¼‰
  CONFIRMED   // å·²ç¡®è®¤
  FAILED      // å¤±è´¥
  CANCELLED   // å·²å–æ¶ˆ
}

// ============ ğŸ”¥ å­—æ®µå˜åŒ–è¯´æ˜ ============
//
// âŒ åˆ é™¤çš„å­—æ®µï¼ˆå¤§é¢æ•°æ®ï¼Œç”±å‰ç«¯æœ¬åœ°å­˜å‚¨ï¼‰ï¼š
// - prompt String @db.Text           (1-10 KB)
// - referenceImage String @db.Text   (1-5 MB)
// - videoUrl String @db.Text         (100 B)
// - imageUrl String @db.Text         (100 B)
// - size String                      (10 B)
// - duration Int                     (4 B)
// - watermark Boolean                (1 B)
// - aspectRatio String               (10 B)
// - metadata Json                    (1-5 KB)
// - taskId String                    (å·²è¢« externalTaskId æ›¿ä»£)
// - isAsync Boolean                  (ä¸éœ€è¦)
// - pollCount Int                    (ä¸éœ€è¦)
// - lastPollTime DateTime            (ä¸éœ€è¦)
// - startedAt DateTime               (ä¸éœ€è¦)
// - apiEndpoint String               (ä¸éœ€è¦ï¼Œä» apiConfigId è·å–)
//
// âœ… æ–°å¢çš„å­—æ®µï¼ˆè½»é‡ä¼˜åŒ–ï¼‰ï¼š
// + promptHash String                (32 Bï¼Œç”¨äºå»é‡)
// + promptPreview String(200)        (200 Bï¼Œç”¨äºé¢„è§ˆ)
//
// ğŸ¯ ç²¾ç®€æ•ˆæœï¼š
// - å½“å‰ï¼šæ¯æ¡è®°å½• ~1-5 MB
// - ä¼˜åŒ–åï¼šæ¯æ¡è®°å½• ~1 KB
// - èŠ‚çœï¼š99% å­˜å‚¨ç©ºé—´
//




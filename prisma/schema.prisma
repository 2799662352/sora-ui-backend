// ğŸ”¥ Sora UI Backend - ç²¾ç®€ç‰ˆ Prisma Schema
// éµå¾ªåŸåˆ™ï¼šKISSï¼ˆKeep It Simpleï¼‰ã€DRYã€Low Coupling
// ä¼˜åŒ–ç›®æ ‡ï¼šåªå­˜å‚¨æ ¸å¿ƒIDæ˜ å°„å’ŒçŠ¶æ€ï¼Œå¤§é¢æ•°æ®ç”±å‰ç«¯æœ¬åœ°å­˜å‚¨

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // ğŸ”¥ ä¼˜åŒ–ï¼šè¿æ¥æ± é…ç½®ï¼ˆå‚è€ƒ Prisma æœ€ä½³å®è·µï¼‰
  // connection_limit: æœ€å¤§è¿æ¥æ•°
  // pool_timeout: è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
  // ç”Ÿäº§ç¯å¢ƒé€šè¿‡ DATABASE_URL å‚æ•°é…ç½®ï¼š
  // postgresql://user:pass@host:5432/db?connection_limit=20&pool_timeout=10
}

// ============ ç”¨æˆ·è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String?  @unique
  password  String
  
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  license   License?
  logs      ActivityLog[]
  videoTasks VideoTask[]
  channels  Channel[]  // ğŸ”¥ æ–°å¢ï¼šAPI Channel ç®¡ç†
  
  @@index([email])
  @@index([username])
  @@map("User")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ============ è®¸å¯è¯è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model License {
  id          String       @id @default(uuid())
  licenseKey  String       @unique
  type        LicenseType
  
  userId      String?      @unique
  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  isActive    Boolean      @default(true)
  deviceId    String?
  features    Json         @default("{}")
  
  activatedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([licenseKey])
  @@index([userId])
  @@map("License")
}

enum LicenseType {
  TRIAL
  PRO
  ENTERPRISE
}

// ============ æ´»åŠ¨æ—¥å¿—è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action    String
  details   Json     @default("{}")
  
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("ActivityLog")
}

// ============ ç³»ç»Ÿé…ç½®è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("SystemConfig")
}

// ============ ğŸ”¥ è§†é¢‘ä»»åŠ¡è¡¨ï¼ˆå…¼å®¹ç‰ˆï¼šæ–°æ—§æ¨¡å¼å…±å­˜ï¼‰ ============
model VideoTask {
  id              String       @id @default(uuid())
  videoId         String       @unique  // å†…éƒ¨è§†é¢‘ ID
  externalTaskId  String?              // ğŸ”¥ æ–°å­—æ®µï¼šå¤–éƒ¨ API çš„ä»»åŠ¡ ID
  
  // ç”¨æˆ·å…³è”
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ğŸ”¥ æ ¸å¿ƒçŠ¶æ€ä¿¡æ¯
  status          TaskStatus   @default(QUEUED)
  progress        Int          @default(0)  // 0-100
  
  // ğŸ”¥ åŸºæœ¬ä¿¡æ¯
  model           String                    // æ¨¡å‹åç§°
  apiConfigId     String?                   // API é…ç½® ID
  mediaType       MediaType    @default(VIDEO)
  
  // ğŸ”¥ æ–°å­—æ®µï¼šPrompt æ‘˜è¦ï¼ˆç²¾ç®€æ¨¡å¼ï¼‰
  promptHash      String?                   // Prompt Hashï¼ˆå»é‡ï¼‰
  promptPreview   String?      @db.VarChar(200) // Prompt é¢„è§ˆ
  
  // ğŸ”¥ æ—§å­—æ®µï¼šå®Œæ•´æ•°æ®ï¼ˆæ—§æ¨¡å¼å…¼å®¹ï¼‰
  prompt          String?      @db.Text    // å®Œæ•´ Promptï¼ˆæ—§æ¨¡å¼ï¼‰
  referenceImage  String?      @db.Text    // å‚è€ƒå›¾ç‰‡ï¼ˆæ—§æ¨¡å¼ï¼‰
  videoUrl        String?      @db.Text    // è§†é¢‘URLï¼ˆæ—§æ¨¡å¼ï¼‰
  imageUrl        String?      @db.Text    // å›¾ç‰‡URL
  size            String?                  // å°ºå¯¸
  duration        Int?                     // æ—¶é•¿
  aspectRatio     String?                  // å®½é«˜æ¯”
  watermark       Boolean      @default(false)
  
  // ğŸ”¥ æ—§å­—æ®µï¼šå¼‚æ­¥ä»»åŠ¡ç›¸å…³
  isAsync         Boolean      @default(false)
  apiEndpoint     String?
  pollCount       Int          @default(0)
  startedAt       DateTime?
  lastPollTime    DateTime?
  
  // ğŸ”¥ æ—§å­—æ®µï¼šMetadataï¼ˆå…¼å®¹ï¼‰
  metadata        Json?        @db.JsonB
  
  // ğŸ”¥ é”™è¯¯ä¿¡æ¯
  errorCode       String?
  errorMessage    String?      @db.Text
  
  // ğŸ”¥ æ—¶é—´æˆ³
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?
  
  // ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
  @@index([videoId])
  @@index([externalTaskId])
  @@index([userId, status])
  @@index([status, createdAt])
  @@index([promptHash])
  @@map("VideoTask")
}

enum TaskStatus {
  QUEUED      // æ’é˜Ÿä¸­
  PROCESSING  // å¤„ç†ä¸­
  COMPLETED   // å·²å®Œæˆ
  FAILED      // å¤±è´¥
  CANCELLED   // å·²å–æ¶ˆ
}

enum MediaType {
  VIDEO       // è§†é¢‘
  IMAGE       // å›¾ç‰‡
}

// ============ ğŸ”¥ API Channel è¡¨ï¼ˆå¢å¼ºç‰ˆ - å®Œå…¨å‚è€ƒ LiteLLMï¼‰ ============
model Channel {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  
  // åŸºæœ¬ä¿¡æ¯
  name        String
  type        String   // 'openai', 'azure', 'sora', 'custom'
  baseURL     String   @map("base_url")
  apiKey      String   @map("api_key")
  
  // æ¨¡å‹æ”¯æŒ
  models      String[] // æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
  
  // è´Ÿè½½å‡è¡¡
  priority    Int      @default(1)  // æƒé‡ï¼ˆ1-100ï¼‰
  status      String   @default("active")  // 'active', 'disabled'
  groupName   String?  @map("group_name")  // åˆ†ç»„åç§°
  
  // ğŸ”¥ LiteLLM: é™æµï¼ˆå¤šç»´åº¦ï¼‰
  rateLimit   Int?     @map("rate_limit")       // RPM é™åˆ¶
  tpmLimit    BigInt?  @map("tpm_limit")        // TPM é™åˆ¶ï¼ˆTokens Per Minuteï¼‰
  maxParallelReqs Int? @map("max_parallel_reqs")// æœ€å¤§å¹¶å‘è¯·æ±‚
  
  // ğŸ”¥ LiteLLM: æˆæœ¬ç»Ÿè®¡ï¼ˆè¯¦ç»†ï¼‰
  totalCost      Float    @default(0) @map("total_cost")    // æ€»æˆæœ¬
  spendToday     Float    @default(0) @map("spend_today")   // ä»Šæ—¥æ¶ˆè´¹
  spendThisMonth Float    @default(0) @map("spend_month")   // æœ¬æœˆæ¶ˆè´¹
  modelSpend     Json?    @default("{}") @map("model_spend")// æŒ‰æ¨¡å‹ç»Ÿè®¡ {"gpt-4": 123.45}
  
  // ğŸ”¥ LiteLLM: é¢„ç®—ç®¡ç†
  maxBudget      Float?   @map("max_budget")                // æœ€å¤§é¢„ç®—
  softBudget     Float?   @map("soft_budget")               // è½¯é¢„ç®—ï¼ˆè­¦å‘Šï¼‰
  budgetResetAt  DateTime? @map("budget_reset_at")          // é¢„ç®—é‡ç½®æ—¶é—´
  
  // ğŸ”¥ LiteLLM: å¥åº·çŠ¶æ€ï¼ˆCooldownæœºåˆ¶ï¼‰
  isHealthy      Boolean  @default(true) @map("is_healthy") // æ˜¯å¦å¥åº·
  failureCount   Int      @default(0) @map("failure_count") // è¿ç»­å¤±è´¥æ¬¡æ•°
  cooldownUntil  DateTime? @map("cooldown_until")           // å†·å´æœŸç»“æŸæ—¶é—´
  lastFailedAt   DateTime? @map("last_failed_at")           // æœ€åå¤±è´¥æ—¶é—´
  
  // ğŸ”¥ LiteLLM: æ€§èƒ½æŒ‡æ ‡
  avgLatencyMs   Int?     @map("avg_latency_ms")            // å¹³å‡å»¶è¿Ÿ
  successRate    Float    @default(1.0) @map("success_rate")// æˆåŠŸç‡ï¼ˆ0-1ï¼‰
  activeRequests Int      @default(0) @map("active_requests")// å½“å‰æ´»è·ƒè¯·æ±‚æ•°
  
  // ç»Ÿè®¡
  totalCalls  Int      @default(0) @map("total_calls")
  lastUsedAt  DateTime? @map("last_used_at")
  
  // ğŸ”¥ LiteLLM: çµæ´»å…ƒæ•°æ®
  metadata    Json?    @default("{}") // æ‰©å±•å­—æ®µ
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // å…³è”
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  requestLogs RequestLog[]  // ğŸ”¥ æ–°å¢ï¼šè¯·æ±‚æ—¥å¿—å…³è”
  
  // ç´¢å¼•
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([groupName])
  @@index([isHealthy])  // ğŸ”¥ æ–°å¢ï¼šå¥åº·çŠ¶æ€ç´¢å¼•
  @@map("Channel")
}

// ============ ğŸ”¥ è¯·æ±‚æ—¥å¿—è¡¨ï¼ˆæ–°å¢ - å‚è€ƒ LiteLLM SpendLogsï¼‰ ============
model RequestLog {
  id                String   @id @default(uuid())
  requestId         String   @unique @map("request_id")       // è¯·æ±‚å”¯ä¸€ID
  
  // å…³è”
  channelId         String   @map("channel_id")
  userId            String   @map("user_id")
  channel           Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  // ğŸ”¥ LiteLLM: è¯·æ±‚ä¿¡æ¯
  model             String                                     // æ¨¡å‹åç§°
  modelGroup        String?  @map("model_group")              // æ¨¡å‹ç»„
  callType          String   @default("completion") @map("call_type") // completion/embedding/chat
  customProvider    String?  @map("custom_provider")          // è‡ªå®šä¹‰æä¾›å•†
  
  // ğŸ”¥ LiteLLM: æˆæœ¬å’ŒToken
  spend             Float    @default(0.0)                    // æœ¬æ¬¡è¯·æ±‚æˆæœ¬
  totalTokens       Int      @default(0) @map("total_tokens")
  promptTokens      Int      @default(0) @map("prompt_tokens")
  completionTokens  Int      @default(0) @map("completion_tokens")
  
  // ğŸ”¥ LiteLLM: æ—¶é—´è¿½è¸ª
  startTime         DateTime @map("start_time")               // è¯·æ±‚å¼€å§‹
  endTime           DateTime @map("end_time")                 // è¯·æ±‚ç»“æŸ
  responseTimeMs    Int?     @map("response_time_ms")         // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  
  // ğŸ”¥ çŠ¶æ€
  status            String   @default("success")              // success/error
  errorMessage      String?  @db.Text @map("error_message")
  httpStatus        Int?     @map("http_status")              // HTTPçŠ¶æ€ç 
  
  // ğŸ”¥ LiteLLM: å…ƒæ•°æ®
  metadata          Json?    @default("{}")                   // æ‰©å±•ä¿¡æ¯
  
  // æ—¶é—´æˆ³
  createdAt         DateTime @default(now()) @map("created_at")
  
  // ç´¢å¼•ï¼ˆé‡è¦ï¼æŸ¥è¯¢æ€§èƒ½ï¼‰
  @@index([channelId])
  @@index([userId])
  @@index([model])
  @@index([startTime])
  @@index([status])
  @@map("RequestLog")
}

// ============ ğŸ”¥ å­—æ®µå˜åŒ–è¯´æ˜ ============
//
// âŒ åˆ é™¤çš„å­—æ®µï¼ˆå¤§é¢æ•°æ®ï¼Œç”±å‰ç«¯æœ¬åœ°å­˜å‚¨ï¼‰ï¼š
// - prompt String @db.Text           (1-10 KB)
// - referenceImage String @db.Text   (1-5 MB)
// - videoUrl String @db.Text         (100 B)
// - imageUrl String @db.Text         (100 B)
// - size String                      (10 B)
// - duration Int                     (4 B)
// - watermark Boolean                (1 B)
// - aspectRatio String               (10 B)
// - metadata Json                    (1-5 KB)
// - taskId String                    (å·²è¢« externalTaskId æ›¿ä»£)
// - isAsync Boolean                  (ä¸éœ€è¦)
// - pollCount Int                    (ä¸éœ€è¦)
// - lastPollTime DateTime            (ä¸éœ€è¦)
// - startedAt DateTime               (ä¸éœ€è¦)
// - apiEndpoint String               (ä¸éœ€è¦ï¼Œä» apiConfigId è·å–)
//
// âœ… æ–°å¢çš„å­—æ®µï¼ˆè½»é‡ä¼˜åŒ–ï¼‰ï¼š
// + promptHash String                (32 Bï¼Œç”¨äºå»é‡)
// + promptPreview String(200)        (200 Bï¼Œç”¨äºé¢„è§ˆ)
//
// ğŸ¯ ç²¾ç®€æ•ˆæœï¼š
// - å½“å‰ï¼šæ¯æ¡è®°å½• ~1-5 MB
// - ä¼˜åŒ–åï¼šæ¯æ¡è®°å½• ~1 KB
// - èŠ‚çœï¼š99% å­˜å‚¨ç©ºé—´
//


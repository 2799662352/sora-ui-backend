// ğŸ”¥ Sora UI Backend - ç²¾ç®€ç‰ˆ Prisma Schema
// éµå¾ªåŸåˆ™ï¼šKISSï¼ˆKeep It Simpleï¼‰ã€DRYã€Low Coupling
// ä¼˜åŒ–ç›®æ ‡ï¼šåªå­˜å‚¨æ ¸å¿ƒIDæ˜ å°„å’ŒçŠ¶æ€ï¼Œå¤§é¢æ•°æ®ç”±å‰ç«¯æœ¬åœ°å­˜å‚¨

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ç”¨æˆ·è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String?  @unique
  password  String
  
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  license   License?
  logs      ActivityLog[]
  videoTasks VideoTask[]
  
  @@index([email])
  @@index([username])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ============ è®¸å¯è¯è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model License {
  id          String       @id @default(uuid())
  licenseKey  String       @unique
  type        LicenseType
  
  userId      String?      @unique
  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  isActive    Boolean      @default(true)
  deviceId    String?
  features    Json         @default("{}")
  
  activatedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([licenseKey])
  @@index([userId])
}

enum LicenseType {
  TRIAL
  PRO
  ENTERPRISE
}

// ============ æ´»åŠ¨æ—¥å¿—è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action    String
  details   Json     @default("{}")
  
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ============ ç³»ç»Ÿé…ç½®è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰ ============
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ ğŸ”¥ è§†é¢‘ä»»åŠ¡è¡¨ï¼ˆç²¾ç®€ç‰ˆï¼‰ ============
model VideoTask {
  id              String       @id @default(uuid())
  videoId         String       @unique  // å†…éƒ¨è§†é¢‘ ID
  externalTaskId  String?              // å¤–éƒ¨ API çš„ä»»åŠ¡ ID
  
  // ç”¨æˆ·å…³è”
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ğŸ”¥ æ ¸å¿ƒçŠ¶æ€ä¿¡æ¯ï¼ˆè½»é‡ï¼‰
  status          TaskStatus   @default(QUEUED)
  progress        Int          @default(0)  // 0-100
  
  // ğŸ”¥ åŸºæœ¬ä¿¡æ¯ï¼ˆå¿…éœ€ï¼Œè½»é‡ï¼‰
  model           String                    // æ¨¡å‹åç§°ï¼šsora_video2, gemini ç­‰
  apiConfigId     String?                   // ä½¿ç”¨çš„ API é…ç½® ID
  mediaType       MediaType    @default(VIDEO) // VIDEO æˆ– IMAGE
  
  // ğŸ”¥ Prompt æ‘˜è¦ï¼ˆç”¨äºå»é‡å’Œæœç´¢ï¼Œä¸å­˜å®Œæ•´å†…å®¹ï¼‰
  promptHash      String?                   // Prompt çš„ SHA256 hash
  promptPreview   String?      @db.VarChar(200) // Prompt å‰ 200 å­—ç¬¦
  
  // ğŸ”¥ é”™è¯¯ä¿¡æ¯ï¼ˆç®€åŒ–ï¼‰
  errorCode       String?                   // é”™è¯¯ä»£ç 
  errorMessage    String?      @db.Text    // é”™è¯¯ä¿¡æ¯æ–‡æœ¬
  
  // ğŸ”¥ æ—¶é—´æˆ³ï¼ˆå¿…éœ€ï¼‰
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?
  
  // ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ç´¢å¼•ï¼ˆç²¾ç®€ç‰ˆï¼‰
  @@index([videoId])           // ä¸»æŸ¥è¯¢
  @@index([externalTaskId])    // å¤–éƒ¨IDæŸ¥è¯¢
  @@index([userId, status])    // ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨
  @@index([status, createdAt]) // å…¨å±€ä»»åŠ¡é˜Ÿåˆ—
  @@index([promptHash])        // å»é‡æŸ¥è¯¢
}

enum TaskStatus {
  QUEUED      // æ’é˜Ÿä¸­
  PROCESSING  // å¤„ç†ä¸­
  COMPLETED   // å·²å®Œæˆ
  FAILED      // å¤±è´¥
  CANCELLED   // å·²å–æ¶ˆ
}

enum MediaType {
  VIDEO       // è§†é¢‘
  IMAGE       // å›¾ç‰‡
}

// ============ ğŸ”¥ å­—æ®µå˜åŒ–è¯´æ˜ ============
//
// âŒ åˆ é™¤çš„å­—æ®µï¼ˆå¤§é¢æ•°æ®ï¼Œç”±å‰ç«¯æœ¬åœ°å­˜å‚¨ï¼‰ï¼š
// - prompt String @db.Text           (1-10 KB)
// - referenceImage String @db.Text   (1-5 MB)
// - videoUrl String @db.Text         (100 B)
// - imageUrl String @db.Text         (100 B)
// - size String                      (10 B)
// - duration Int                     (4 B)
// - watermark Boolean                (1 B)
// - aspectRatio String               (10 B)
// - metadata Json                    (1-5 KB)
// - taskId String                    (å·²è¢« externalTaskId æ›¿ä»£)
// - isAsync Boolean                  (ä¸éœ€è¦)
// - pollCount Int                    (ä¸éœ€è¦)
// - lastPollTime DateTime            (ä¸éœ€è¦)
// - startedAt DateTime               (ä¸éœ€è¦)
// - apiEndpoint String               (ä¸éœ€è¦ï¼Œä» apiConfigId è·å–)
//
// âœ… æ–°å¢çš„å­—æ®µï¼ˆè½»é‡ä¼˜åŒ–ï¼‰ï¼š
// + promptHash String                (32 Bï¼Œç”¨äºå»é‡)
// + promptPreview String(200)        (200 Bï¼Œç”¨äºé¢„è§ˆ)
//
// ğŸ¯ ç²¾ç®€æ•ˆæœï¼š
// - å½“å‰ï¼šæ¯æ¡è®°å½• ~1-5 MB
// - ä¼˜åŒ–åï¼šæ¯æ¡è®°å½• ~1 KB
// - èŠ‚çœï¼š99% å­˜å‚¨ç©ºé—´
//

